<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Study Cards - Multi-File Loader (New Naming)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@400;700&family=Electrolize&family=Fredoka+One&family=Bangers&family=Lobster&family=Playfair+Display:wght@400;700&family=Lato:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@floating-ui/core@1.6.0/dist/floating-ui.core.umd.js"></script>
    <script src="https://unpkg.com/@floating-ui/dom@1.6.3/dist/floating-ui.dom.umd.js"></script>
    <style>
        :root {
            /* Layout Variables (mostly unchanged by themes) */
            --sidebar-width: 220px;
            --header-height: 50px;
            --brick-max-width: 320px;
            --brick-min-width-auto: 240px;
            --transition-duration: 0.3s;
            --border-radius-base: 6px;
            --border-radius-small: 4px;

            /* Default Theme (Daylight) Variables */
            --font-primary: 'Roboto', Arial, sans-serif;
            --font-secondary: 'Roboto', Arial, sans-serif; /* For specific elements if needed */
            --font-size-base: 13.5px;
            --line-height-base: 1.45;

            --bg-page: #eef1f5;
            --bg-header: #002244;
            --bg-sidebar: #003366;
            --bg-settings-dropdown: #003366;
            --bg-brick: #ffffff;
            --bg-button-nav: #004080;
            --bg-button-nav-hover: #0059b3;
            --bg-button-nav-active: #007bff;
            --bg-button-control: #004080; /* For settings buttons */
            --bg-button-control-hover: #0059b3;
            --bg-button-control-active: #007bff;
            --bg-popup-hover: #4A5568;
            --bg-popover-card: #fff;
            
            --text-body: #444;
            --text-header: white;
            --text-sidebar: #fff;
            --text-settings-dropdown: #fff;
            --text-settings-group-title: #a8c0d8;
            --text-brick: #444;
            --text-brick-title: #0059b3;
            --text-content-header: #003366;
            --text-button-nav: #fff;
            --text-button-control: white;
            --text-link: #004880;
            --text-link-hover: #0059b3;
            --text-link-active: #c9302c;
            --text-popup-hover: #E2E8F0;
            --text-popup-hover-strong: #F6E05E;
            --text-popup-hover-em: #63B3ED;
            --text-popover-card-header: #0059b3;
            --text-popover-card-body: #444;
            --text-popover-card-strong: #d95f53;
            --text-popover-card-em: #31708f;
            --text-loading: #555;
            --text-error: red;
            --text-sidebar-placeholder: #ccc;
            --text-file-loader-label: #a8c0d8;
            --text-file-picker: white; /* For the input itself, specific to sidebar */

            --border-brick: #d8dde3;
            --border-brick-title: #e0e0e0;
            --border-content-header: #0059b3;
            --border-sidebar-divider: #004080; /* Sidebar h2, file loader area */
            --border-settings-dropdown: #004080;
            --border-settings-group: #004080;
            --border-link-dotted: #007bff;
            --border-popover-card: #c5cdd7;
            --border-popover-card-header: #e8edf1;

            --shadow-header: 0 2px 5px rgba(0,0,0,0.2);
            --shadow-sidebar: 2px 0 5px rgba(0,0,0,0.1);
            --shadow-brick: 0 1px 2px rgba(0,0,0,0.06);
            --shadow-brick-hover: 0 3px 8px rgba(0,0,0,0.12);
            --shadow-nav-button-active: inset 2px 2px 4px rgba(0,0,0,0.2);
            --shadow-settings-dropdown: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-popup-hover: 0 2px 8px rgba(0,0,0,0.2);
            --shadow-popover-card: 0 5px 15px rgba(0,0,0,0.2);

            --hamburger-btn-color: white;
            --hamburger-btn-hover-bg: rgba(255,255,255,0.1);
            --settings-btn-color: white;
            --settings-btn-hover-bg: rgba(255,255,255,0.1);
            --popover-close-btn-color: #aaa;
            --popover-close-btn-hover-color: #333;
        }

        /* --- Night Time Theme --- */
        body.theme-night-time {
            --font-primary: 'Open Sans', sans-serif;
            --bg-page: #1a1f2c;
            --bg-header: #1f2536;
            --bg-sidebar: #2c3346;
            --bg-settings-dropdown: #2c3346;
            --bg-brick: #252b3b;
            --bg-button-nav: #3a4258;
            --bg-button-nav-hover: #4a526b;
            --bg-button-nav-active: #5c6784;
            --bg-button-control: #3a4258;
            --bg-button-control-hover: #4a526b;
            --bg-button-control-active: #5c6784;
            --bg-popup-hover: #3a4258;
            --bg-popover-card: #2c3346;
            
            --text-body: #d8dee9;
            --text-header: #e5e9f0;
            --text-sidebar: #e5e9f0;
            --text-settings-dropdown: #e5e9f0;
            --text-settings-group-title: #a3b8cc;
            --text-brick: #d8dee9;
            --text-brick-title: #88c0d0;
            --text-content-header: #88c0d0;
            --text-button-nav: #e5e9f0;
            --text-button-control: #e5e9f0;
            --text-link: #81a1c1;
            --text-link-hover: #88c0d0;
            --text-link-active: #bf616a;
            --text-popup-hover: #d8dee9;
            --text-popup-hover-strong: #ebcb8b;
            --text-popup-hover-em: #a3be8c;
            --text-popover-card-header: #88c0d0;
            --text-popover-card-body: #d8dee9;
            --text-popover-card-strong: #bf616a;
            --text-popover-card-em: #b48ead;
            --text-loading: #b0b8c9;
            --text-error: #e06c75; /* Light red for dark themes */
            --text-sidebar-placeholder: #788297;
            --text-file-loader-label: #a3b8cc;
            --text-file-picker: #d8dee9;

            --border-brick: #3b4252;
            --border-brick-title: #434c5e;
            --border-content-header: #5e81ac;
            --border-sidebar-divider: #3b4252;
            --border-settings-dropdown: #3b4252;
            --border-settings-group: #3b4252;
            --border-link-dotted: #81a1c1;
            --border-popover-card: #434c5e;
            --border-popover-card-header: #434c5e;

            --shadow-header: 0 2px 5px rgba(0,0,0,0.3);
            --shadow-sidebar: 2px 0 5px rgba(0,0,0,0.25);
            --shadow-brick: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-brick-hover: 0 3px 8px rgba(0,0,0,0.3);
            --shadow-nav-button-active: inset 2px 2px 4px rgba(0,0,0,0.3);
            --shadow-settings-dropdown: 0 4px 12px rgba(0,0,0,0.25);
            --shadow-popup-hover: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-popover-card: 0 5px 15px rgba(0,0,0,0.3);

            --hamburger-btn-color: var(--text-header);
            --hamburger-btn-hover-bg: rgba(229,233,240,0.1); /* Lighter version of text-header */
            --settings-btn-color: var(--text-header);
            --settings-btn-hover-bg: rgba(229,233,240,0.1);
            --popover-close-btn-color: #9090a0;
            --popover-close-btn-hover-color: #d8dee9;
        }
        
        /* --- Monochromatic Theme --- */
        body.theme-monochromatic {
            --font-primary: 'Lato', sans-serif;
            --bg-page: #f0f0f0;
            --bg-header: #555555;
            --bg-sidebar: #666666;
            --bg-settings-dropdown: #666666;
            --bg-brick: #ffffff;
            --bg-button-nav: #777777;
            --bg-button-nav-hover: #888888;
            --bg-button-nav-active: #444444;
            --bg-button-control: #777777;
            --bg-button-control-hover: #888888;
            --bg-button-control-active: #444444;
            --bg-popup-hover: #505050;
            --bg-popover-card: #fdfdfd;
            
            --text-body: #333333;
            --text-header: #ffffff;
            --text-sidebar: #eeeeee;
            --text-settings-dropdown: #eeeeee;
            --text-settings-group-title: #cccccc;
            --text-brick: #333333;
            --text-brick-title: #222222;
            --text-content-header: #444444;
            --text-button-nav: #ffffff;
            --text-button-control: #ffffff;
            --text-link: #505050;
            --text-link-hover: #303030;
            --text-link-active: #111111;
            --text-popup-hover: #eeeeee;
            --text-popup-hover-strong: #bbbbbb;
            --text-popup-hover-em: #dddddd;
            --text-popover-card-header: #222222;
            --text-popover-card-body: #333333;
            --text-popover-card-strong: #660000; /* Slight color for emphasis */
            --text-popover-card-em: #003366; /* Slight color for emphasis */
            --text-loading: #666666;
            --text-error: #990000;
            --text-sidebar-placeholder: #bbbbbb;
            --text-file-loader-label: #cccccc;
            --text-file-picker: #eeeeee;

            --border-brick: #cccccc;
            --border-brick-title: #dddddd;
            --border-content-header: #777777;
            --border-sidebar-divider: #888888;
            --border-settings-dropdown: #888888;
            --border-settings-group: #888888;
            --border-link-dotted: #505050;
            --border-popover-card: #bbbbbb;
            --border-popover-card-header: #dddddd;
        }
        /* --- Monochromatic Night Theme --- */
        body.theme-monochromatic-night {
            --font-primary: 'Lato', sans-serif;
            --bg-page: #1c1c1c;
            --bg-header: #333333;
            --bg-sidebar: #2a2a2a;
            --bg-settings-dropdown: #2a2a2a;
            --bg-brick: #222222;
            --bg-button-nav: #404040;
            --bg-button-nav-hover: #4d4d4d;
            --bg-button-nav-active: #5a5a5a;
            --bg-button-control: #404040;
            --bg-button-control-hover: #4d4d4d;
            --bg-button-control-active: #5a5a5a;
            --bg-popup-hover: #383838;
            --bg-popover-card: #252525;
            
            --text-body: #d0d0d0;
            --text-header: #f0f0f0;
            --text-sidebar: #e0e0e0;
            --text-settings-dropdown: #e0e0e0;
            --text-settings-group-title: #707070;
            --text-brick: #d0d0d0;
            --text-brick-title: #e0e0e0;
            --text-content-header: #c0c0c0;
            --text-button-nav: #f0f0f0;
            --text-button-control: #f0f0f0;
            --text-link: #a0a0a0;
            --text-link-hover: #b0b0b0;
            --text-link-active: #c0c0c0;
            --text-popup-hover: #e0e0e0;
            --text-popup-hover-strong: #f0f0f0;
            --text-popup-hover-em: #cccccc;
            --text-popover-card-header: #e0e0e0;
            --text-popover-card-body: #d0d0d0;
            --text-popover-card-strong: #aaaaaa; 
            --text-popover-card-em: #bbbbbb; 
            --text-loading: #909090;
            --text-error: #b35f68;
            --text-sidebar-placeholder: #606060;
            --text-file-loader-label: #707070;
            --text-file-picker: #e0e0e0;

            --border-brick: #3a3a3a;
            --border-brick-title: #444444;
            --border-content-header: #555555;
            --border-sidebar-divider: #383838;
            --border-settings-dropdown: #383838;
            --border-settings-group: #383838;
            --border-link-dotted: #a0a0a0;
            --border-popover-card: #3f3f3f;
            --border-popover-card-header: #444444;
        }
        /* --- Futuristic Theme --- */
        body.theme-futuristic {
            --font-primary: 'Orbitron', sans-serif;
            --font-secondary: 'Electrolize', sans-serif;
            --bg-page: #0a0f1f;
            --bg-header: #0d1225;
            --bg-sidebar: #101830;
            --bg-settings-dropdown: #101830;
            --bg-brick: #182040;
            --bg-button-nav: #00a1c0; /* Cyan-ish */
            --bg-button-nav-hover: #00c1e0;
            --bg-button-nav-active: #00e1ff;
            --bg-button-control: #00a1c0;
            --bg-button-control-hover: #00c1e0;
            --bg-button-control-active: #00e1ff;
            --bg-popup-hover: #1f2a50;
            --bg-popover-card: #151c35;
            
            --text-body: #c0c8e0;
            --text-header: #00d1ff; /* Bright Cyan */
            --text-sidebar: #a0a8c0;
            --text-settings-dropdown: #a0a8c0;
            --text-settings-group-title: #606880;
            --text-brick: #c0c8e0;
            --text-brick-title: #00e1ff;
            --text-content-header: #00d1ff;
            --text-button-nav: #0a0f1f; /* Dark text on bright button */
            --text-button-control: #0a0f1f;
            --text-link: #00f2ea; /* Tealish cyan */
            --text-link-hover: #30ffff;
            --text-link-active: #90ffff;
            --text-popup-hover: #e0e0f0;
            --text-popup-hover-strong: #00ffaa;
            --text-popup-hover-em: #00ccee;
            --text-popover-card-header: #00e1ff;
            --text-popover-card-body: #c0c8e0;
            --text-popover-card-strong: #ff55aa; 
            --text-popover-card-em: #55aaff; 
            --text-loading: #8088a0;
            --text-error: #ff4060;
            --text-sidebar-placeholder: #505870;
            --text-file-loader-label: #606880;
            --text-file-picker: #a0a8c0;

            --border-brick: #0081a0;
            --border-brick-title: #00a1c0;
            --border-content-header: #00b1d0;
            --border-sidebar-divider: #006180;
            --border-settings-dropdown: #006180;
            --border-settings-group: #006180;
            --border-link-dotted: #00f2ea;
            --border-popover-card: #0081a0;
            --border-popover-card-header: #00a1c0;
            --border-radius-base: 2px; /* Sharper edges */
            --border-radius-small: 0px;
        }
        body.theme-funky {
            --font-primary: 'Bangers', cursive;
            --font-secondary: 'Fredoka One', cursive;
            --bg-page: #fffacd; --text-body: #4b0082; /* LemonChiffon, Indigo */
            --bg-header: #ff69b4; --text-header: #ffff00; /* HotPink, Yellow */
            --bg-sidebar: #ff1493; --text-sidebar: #ffff00; /* DeepPink, Yellow */
            --bg-settings-dropdown: #ff1493;
            --bg-brick: #98fb98; --text-brick: #ff4500; /* PaleGreen, OrangeRed */
            --bg-button-nav: #00fa9a; --text-button-nav: #4b0082; /* MediumSpringGreen, Indigo */
            --bg-button-nav-hover: #00ff7f; /* SpringGreen */
            --bg-button-nav-active: #ff00ff; --text-button-nav-active: #ffffff; /* Fuchsia, White */
            --bg-button-control: var(--bg-button-nav);
            --bg-button-control-hover: var(--bg-button-nav-hover);
            --bg-button-control-active: var(--bg-button-nav-active);
            --bg-popup-hover: #4b0082; --text-popup-hover: #fffacd;
            --bg-popover-card: #adff2f; /* GreenYellow */
            
            --text-settings-group-title: #fffacd;
            --text-brick-title: #0000cd; /* MediumBlue */
            --text-content-header: #ff4500; /* OrangeRed */
            --text-button-control: var(--text-button-nav);
            --text-link: #1e90ff; /* DodgerBlue */
            --text-link-hover: #ff7f50; /* Coral */
            --text-link-active: #ff00ff; /* Fuchsia */
            --text-popup-hover-strong: #ff69b4;
            --text-popup-hover-em: #98fb98;
            --text-popover-card-header: #0000cd;
            --text-popover-card-body: #4b0082;
            --text-popover-card-strong: #ff4500;
            --text-popover-card-em: #1e90ff;
            --text-loading: #4b0082;
            --text-error: #dc143c; /* Crimson */
            --text-sidebar-placeholder: #fffacd;
            --text-file-loader-label: #fffacd;
            --text-file-picker: #4b0082;

            --border-brick: #ff00ff; /* Fuchsia */
            --border-brick-title: #00fa9a;
            --border-content-header: #ff4500;
            --border-sidebar-divider: #ffff00;
            --border-settings-dropdown: var(--border-sidebar-divider);
            --border-settings-group: var(--border-sidebar-divider);
            --border-link-dotted: #1e90ff;
            --border-popover-card: #0000cd;
            --border-popover-card-header: #00fa9a;
            --border-radius-base: 10px;
            --border-radius-small: 5px;
        }
        body.theme-vintage {
            --font-primary: 'Playfair Display', serif;
            --font-secondary: 'Lobster', cursive;
            --bg-page: #f5f5dc; --text-body: #5d4037; /* Beige, Brown */
            --bg-header: #8b4513; --text-header: #fdf5e6; /* SaddleBrown, OldLace */
            --bg-sidebar: #a0522d; --text-sidebar: #fff8dc; /* Sienna, Cornsilk */
            --bg-settings-dropdown: #a0522d;
            --bg-brick: #fffaf0; --text-brick: #795548; /* FloralWhite, Brown */
            --bg-button-nav: #d2b48c; --text-button-nav: #5d4037; /* Tan, DarkBrown */
            --bg-button-nav-hover: #c1a37c;
            --bg-button-nav-active: #800000; --text-button-nav-active: #fff8dc; /* Maroon, Cornsilk */
            --bg-button-control: var(--bg-button-nav);
            --bg-button-control-hover: var(--bg-button-nav-hover);
            --bg-button-control-active: var(--bg-button-nav-active);
            --bg-popup-hover: #795548; --text-popup-hover: #f5f5dc;
            --bg-popover-card: #fdf5e6; /* OldLace */
            
            --text-settings-group-title: #fff8dc;
            --text-brick-title: #6b4226; /* Brown, similar to Sienna */
            --text-content-header: #800000; /* Maroon */
            --text-button-control: var(--text-button-nav);
            --text-link: #8b0000; /* DarkRed */
            --text-link-hover: #a52a2a; /* Brown */
            --text-link-active: #5e2009;
            --text-popup-hover-strong: #d2b48c;
            --text-popup-hover-em: #f5f5dc;
            --text-popover-card-header: #800000;
            --text-popover-card-body: #5d4037;
            --text-popover-card-strong: #a52a2a;
            --text-popover-card-em: #6b4226;
            --text-loading: #5d4037;
            --text-error: #b22222; /* Firebrick */
            --text-sidebar-placeholder: #f5deb3; /* Wheat */
            --text-file-loader-label: #fff8dc;
            --text-file-picker: #5d4037;

            --border-brick: #d2b48c; /* Tan */
            --border-brick-title: #eaddc0;
            --border-content-header: #800000;
            --border-sidebar-divider: #bc8f8f; /* RosyBrown */
            --border-settings-dropdown: var(--border-sidebar-divider);
            --border-settings-group: var(--border-sidebar-divider);
            --border-link-dotted: #8b0000;
            --border-popover-card: #d2b48c;
            --border-popover-card-header: #eaddc0;
        }
        body.theme-classic {
            --font-primary: 'Lato', sans-serif;
            --font-secondary: 'Playfair Display', serif;
            --bg-page: #f8f9fa; --text-body: #343a40; /* Very Light Gray, Dark Gray */
            --bg-header: #2c3e50; --text-header: #ecf0f1; /* Dark Slate Blue, Light Grayish Blue */
            --bg-sidebar: #34495e; --text-sidebar: #ecf0f1; /* Wet Asphalt, Clouds */
            --bg-settings-dropdown: #34495e;
            --bg-brick: #ffffff; --text-brick: #495057; /* White, Gray */
            --bg-button-nav: #1abc9c; --text-button-nav: #ffffff; /* Turquoise, White */
            --bg-button-nav-hover: #16a085; /* Green Sea */
            --bg-button-nav-active: #27ae60; --text-button-nav-active: #ffffff; /* Nephritis, White */
            --bg-button-control: var(--bg-button-nav);
            --bg-button-control-hover: var(--bg-button-nav-hover);
            --bg-button-control-active: var(--bg-button-nav-active);
            --bg-popup-hover: #4a6178; --text-popup-hover: #f8f9fa;
            --bg-popover-card: #ffffff;
            
            --text-settings-group-title: #bdc3c7; /* Silver */
            --text-brick-title: #2980b9; /* Belize Hole (Blue) */
            --text-content-header: #2c3e50; /* Dark Slate Blue */
            --text-button-control: var(--text-button-nav);
            --text-link: #3498db; /* Peter River (Blue) */
            --text-link-hover: #2980b9; /* Belize Hole */
            --text-link-active: #1f618d;
            --text-popup-hover-strong: #e67e22; /* Carrot Orange */
            --text-popup-hover-em: #1abc9c; /* Turquoise */
            --text-popover-card-header: #2980b9;
            --text-popover-card-body: #343a40;
            --text-popover-card-strong: #c0392b; /* Pomegranate (Red) */
            --text-popover-card-em: #27ae60; /* Nephritis */
            --text-loading: #7f8c8d; /* Asbestos */
            --text-error: #e74c3c; /* Alizarin (Red) */
            --text-sidebar-placeholder: #95a5a6; /* Concrete */
            --text-file-loader-label: #bdc3c7;
            --text-file-picker: #343a40;

            --border-brick: #ced4da; /* Light Gray */
            --border-brick-title: #dee2e6;
            --border-content-header: #1abc9c;
            --border-sidebar-divider: #4a6178;
            --border-settings-dropdown: var(--border-sidebar-divider);
            --border-settings-group: var(--border-sidebar-divider);
            --border-link-dotted: #3498db;
            --border-popover-card: #bdc3c7;
            --border-popover-card-header: #dee2e6;
        }
        
        /* --- 17. Innovative and Audacious (Visme) --- */
        body.theme-innovative-audacious {
            --font-primary: 'Roboto', sans-serif; /* Modern, clean */
            --font-secondary: 'Orbitron', sans-serif; /* For a bit of edge if needed */

            --bg-page: #1F1F21; /* Dark Gray */
            --bg-header: #2A2A2E; /* Slightly lighter dark gray */
            --bg-sidebar: #252529;
            --bg-settings-dropdown: #252529;
            --bg-brick: #333333;
            --bg-button-nav: #F45D4C; /* Portland Orange */
            --bg-button-nav-hover: #E05545;
            --bg-button-nav-active: #C94D3E;
            --bg-button-control: #00A170; /* Jade */
            --bg-button-control-hover: #00B47E;
            --bg-button-control-active: #008D62;
            --bg-popup-hover: #404040;
            --bg-popover-card: #2F2F2F;
            
            --text-body: #EAEAEA;
            --text-header: #FFFA78; /* Vivid Yellow for impact */
            --text-sidebar: #E0E0E0;
            --text-settings-dropdown: #E0E0E0;
            --text-settings-group-title: #B0B0B0;
            --text-brick: #DADADA;
            --text-brick-title: #FFFA78; /* Vivid Yellow */
            --text-content-header: #F45D4C; /* Portland Orange */
            --text-button-nav: #FFFFFF;
            --text-button-control: #FFFFFF;
            --text-link: #00A170; /* Jade */
            --text-link-hover: #30C79A;
            --text-link-active: #F45D4C; /* Portland Orange */
            --text-popup-hover: #FFFFFF;
            --text-popup-hover-strong: #FFFA78;
            --text-popup-hover-em: #00A170;
            --text-popover-card-header: #FFFA78;
            --text-popover-card-body: #DADADA;
            --text-popover-card-strong: #F45D4C;
            --text-popover-card-em: #00A170;
            --text-loading: #C0C0C0;
            --text-error: #FF6B6B;
            --text-sidebar-placeholder: #888888;
            --text-file-loader-label: #B0B0B0;
            --text-file-picker: #E0E0E0;

            --border-brick: #444444;
            --border-brick-title: #555555;
            --border-content-header: #F45D4C;
            --border-sidebar-divider: #404040;
            --border-settings-dropdown: #404040;
            --border-settings-group: #404040;
            --border-link-dotted: #00A170;
            --border-popover-card: #555555;
            --border-popover-card-header: #4A4A4A;
        }

        /* --- 19. Minimal Yet Warm (Visme) --- */
        body.theme-minimal-warm {
            --font-primary: 'Lato', sans-serif; /* Clean and warm */
            --bg-page: #F0EAD6; /* Eggshell White */
            --bg-header: #D1BE9C; /* Dark Vanilla */
            --bg-sidebar: #C1AE8C; /* Slightly darker vanilla */
            --bg-settings-dropdown: #C1AE8C;
            --bg-brick: #FFFFFF;
            --bg-button-nav: #8B8589; /* Taupe Gray */
            --bg-button-nav-hover: #7A7478;
            --bg-button-nav-active: #DA3B47; /* Jelly Bean Red */
            --bg-button-control: #8B8589;
            --bg-button-control-hover: #7A7478;
            --bg-button-control-active: #DA3B47;
            --bg-popup-hover: #A19A9D;
            --bg-popover-card: #FAF5E9; /* Lighter eggshell */
            
            --text-body: #5C585A; /* Darker Taupe */
            --text-header: #FFFFFF;
            --text-sidebar: #FFFFFF;
            --text-settings-dropdown: #FFFFFF;
            --text-settings-group-title: #F0EAD6;
            --text-brick: #5C585A;
            --text-brick-title: #DA3B47; /* Jelly Bean Red */
            --text-content-header: #8B8589; /* Taupe Gray */
            --text-button-nav: #FFFFFF;
            --text-button-control: #FFFFFF;
            --text-link: #DA3B47; /* Jelly Bean Red */
            --text-link-hover: #C92A39;
            --text-link-active: #B0202F;
            --text-popup-hover: #FFFFFF;
            --text-popup-hover-strong: #DA3B47;
            --text-popup-hover-em: #8B8589;
            --text-popover-card-header: #DA3B47;
            --text-popover-card-body: #5C585A;
            --text-popover-card-strong: #DA3B47;
            --text-popover-card-em: #8B8589;
            --text-loading: #7A7478;
            --text-error: #A02C35;
            --text-sidebar-placeholder: #D1BE9C;
            --text-file-loader-label: #F0EAD6;
            --text-file-picker: #5C585A;

            --border-brick: #D1BE9C;
            --border-brick-title: #E0D6C5;
            --border-content-header: #8B8589;
            --border-sidebar-divider: #B0A07F;
            --border-settings-dropdown: #B0A07F;
            --border-settings-group: #B0A07F;
            --border-link-dotted: #DA3B47;
            --border-popover-card: #D1BE9C;
            --border-popover-card-header: #E0D6C5;
        }

        /* --- 20. Vivid and Sharp (Visme) --- */
        body.theme-vivid-sharp {
            --font-primary: 'Open Sans', sans-serif; /* Sharp and readable */
            --bg-page: #2A2043; /* Derived dark for contrast */
            --bg-header: #4A4063; /* Dark Slate Blue */
            --bg-sidebar: #3A3053; /* Darker Slate Blue */
            --bg-settings-dropdown: #3A3053;
            --bg-brick: #5A5073;
            --bg-button-nav: #6A4C9C; /* Royal Purple */
            --bg-button-nav-hover: #7A5CAA;
            --bg-button-nav-active: #D8315B; /* Dark Cerise as active */
            --bg-button-control: #6A4C9C;
            --bg-button-control-hover: #7A5CAA;
            --bg-button-control-active: #D8315B;
            --bg-popup-hover: #5A5073;
            --bg-popover-card: #403659;
            
            --text-body: #E0D8F0;
            --text-header: #FFFFFF;
            --text-sidebar: #F0E8FF;
            --text-settings-dropdown: #F0E8FF;
            --text-settings-group-title: #C0B0E0;
            --text-brick: #E0D8F0;
            --text-brick-title: #D8315B; /* Dark Cerise */
            --text-content-header: #6A4C9C; /* Royal Purple */
            --text-button-nav: #FFFFFF;
            --text-button-control: #FFFFFF;
            --text-link: #D8315B; /* Dark Cerise */
            --text-link-hover: #E8416B;
            --text-link-active: #F06080;
            --text-popup-hover: #FFFFFF;
            --text-popup-hover-strong: #D8315B;
            --text-popup-hover-em: #6A4C9C;
            --text-popover-card-header: #D8315B;
            --text-popover-card-body: #E0D8F0;
            --text-popover-card-strong: #D8315B;
            --text-popover-card-em: #6A4C9C;
            --text-loading: #B0A0D0;
            --text-error: #F07090;
            --text-sidebar-placeholder: #8070A0;
            --text-file-loader-label: #C0B0E0;
            --text-file-picker: #E0D8F0;

            --border-brick: #5A5073;
            --border-brick-title: #6A6083;
            --border-content-header: #6A4C9C;
            --border-sidebar-divider: #50466F;
            --border-settings-dropdown: #50466F;
            --border-settings-group: #50466F;
            --border-link-dotted: #D8315B;
            --border-popover-card: #6A6083;
            --border-popover-card-header: #5A5073;
        }

        /* --- 24. Clean and Modern (Visme) --- */
        body.theme-clean-modern {
            --font-primary: 'Lato', sans-serif; /* Clean, modern */
            --bg-page: #FFFFFF; /* Plain White */
            --bg-header: #3B7B6A; /* Myrtle Green */
            --bg-sidebar: #2A6B5A; /* Darker Myrtle */
            --bg-settings-dropdown: #2A6B5A;
            --bg-brick: #F8FBF9; /* Off-white, close to Azureish */
            --bg-button-nav: #00A08A; /* Keppel / Tealish Green */
            --bg-button-nav-hover: #00B89A;
            --bg-button-nav-active: #3B7B6A; /* Myrtle Green */
            --bg-button-control: #00A08A;
            --bg-button-control-hover: #00B89A;
            --bg-button-control-active: #3B7B6A;
            --bg-popup-hover: #5C9B8A;
            --bg-popover-card: #FFFFFF;
            
            --text-body: #333333;
            --text-header: #FFFFFF;
            --text-sidebar: #D8E2DC; /* Azureish White for text on dark sidebar */
            --text-settings-dropdown: #D8E2DC;
            --text-settings-group-title: #B0C0BA;
            --text-brick: #444444;
            --text-brick-title: #3B7B6A; /* Myrtle Green */
            --text-content-header: #00A08A; /* Keppel */
            --text-button-nav: #FFFFFF;
            --text-button-control: #FFFFFF;
            --text-link: #3B7B6A; /* Myrtle Green */
            --text-link-hover: #00A08A;
            --text-link-active: #2A6B5A;
            --text-popup-hover: #FFFFFF;
            --text-popup-hover-strong: #00A08A;
            --text-popup-hover-em: #D8E2DC;
            --text-popover-card-header: #3B7B6A;
            --text-popover-card-body: #333333;
            --text-popover-card-strong: #CF1259; /* A contrasting accent if needed from another palette */
            --text-popover-card-em: #3B7B6A;
            --text-loading: #666666;
            --text-error: #CC0000;
            --text-sidebar-placeholder: #A0B0AA;
            --text-file-loader-label: #B0C0BA;
            --text-file-picker: #333333; /* On white bg for file input */

            --border-brick: #D8E2DC; /* Azureish White */
            --border-brick-title: #E8EEEB;
            --border-content-header: #00A08A;
            --border-sidebar-divider: #4CA08E;
            --border-settings-dropdown: #4CA08E;
            --border-settings-group: #4CA08E;
            --border-link-dotted: #3B7B6A;
            --border-popover-card: #C8D2CC;
            --border-popover-card-header: #D8E2DC;
        }

        /* --- 40. Modern and Minimalist (Visme) --- */
        body.theme-modern-minimalist {
            --font-primary: 'Roboto', sans-serif; /* Minimalist, modern */
            --bg-page: #1E1E1E; /* Black/Dark Gray */
            --bg-header: #282828; 
            --bg-sidebar: #222222;
            --bg-settings-dropdown: #222222;
            --bg-brick: #333333;
            --bg-button-nav: #499F68; /* Middle Green */
            --bg-button-nav-hover: #5AAF78;
            --bg-button-nav-active: #B46F86; /* Turkish Rose as active */
            --bg-button-control: #499F68;
            --bg-button-control-hover: #5AAF78;
            --bg-button-control-active: #B46F86;
            --bg-popup-hover: #454545;
            --bg-popover-card: #2D2D2D;
            
            --text-body: #CCCCCC;
            --text-header: #FEDC63; /* Yellow */
            --text-sidebar: #DDDDDD;
            --text-settings-dropdown: #DDDDDD;
            --text-settings-group-title: #AAAAAA;
            --text-brick: #CCCCCC;
            --text-brick-title: #B46F86; /* Turkish Rose */
            --text-content-header: #FEDC63; /* Yellow */
            --text-button-nav: #FFFFFF;
            --text-button-control: #FFFFFF;
            --text-link: #499F68; /* Middle Green */
            --text-link-hover: #FEDC63; /* Yellow for hover */
            --text-link-active: #B46F86;
            --text-popup-hover: #FFFFFF;
            --text-popup-hover-strong: #FEDC63;
            --text-popup-hover-em: #499F68;
            --text-popover-card-header: #FEDC63;
            --text-popover-card-body: #CCCCCC;
            --text-popover-card-strong: #B46F86;
            --text-popover-card-em: #499F68;
            --text-loading: #BBBBBB;
            --text-error: #FF7777;
            --text-sidebar-placeholder: #777777;
            --text-file-loader-label: #AAAAAA;
            --text-file-picker: #DDDDDD;

            --border-brick: #4A4A4A;
            --border-brick-title: #555555;
            --border-content-header: #FEDC63;
            --border-sidebar-divider: #404040;
            --border-settings-dropdown: #404040;
            --border-settings-group: #404040;
            --border-link-dotted: #499F68;
            --border-popover-card: #555555;
            --border-popover-card-header: #4A4A4A;
        }

        /* --- 42. Flat Design Colors (Visme) --- */
        body.theme-flat-design {
            --font-primary: 'Open Sans', sans-serif; /* Common for flat design */
            --bg-page: #ECF0F1; /* Clouds (light gray) */
            --bg-header: #3498DB; /* Bright Blue */
            --bg-sidebar: #2C81B8; /* Darker Bright Blue */
            --bg-settings-dropdown: #2C81B8;
            --bg-brick: #FFFFFF;
            --bg-button-nav: #2ECC71; /* Bright Green */
            --bg-button-nav-hover: #27AE60;
            --bg-button-nav-active: #E74C3C; /* Bright Red */
            --bg-button-control: #2ECC71;
            --bg-button-control-hover: #27AE60;
            --bg-button-control-active: #E74C3C;
            --bg-popup-hover: #5DADE2; /* Lighter blue */
            --bg-popover-card: #FBFCFC;
            
            --text-body: #34495E; /* Dark blue/gray for text */
            --text-header: #FFFFFF;
            --text-sidebar: #FDFEFE;
            --text-settings-dropdown: #FDFEFE;
            --text-settings-group-title: #BDC3C7;
            --text-brick: #34495E;
            --text-brick-title: #E74C3C; /* Bright Red */
            --text-content-header: #2ECC71; /* Bright Green */
            --text-button-nav: #FFFFFF;
            --text-button-control: #FFFFFF;
            --text-link: #E74C3C; /* Bright Red */
            --text-link-hover: #F1C40F; /* Bright Yellow */
            --text-link-active: #C0392B;
            --text-popup-hover: #FFFFFF;
            --text-popup-hover-strong: #F1C40F; /* Yellow */
            --text-popup-hover-em: #2ECC71; /* Green */
            --text-popover-card-header: #E74C3C;
            --text-popover-card-body: #34495E;
            --text-popover-card-strong: #E74C3C;
            --text-popover-card-em: #3498DB; /* Blue */
            --text-loading: #7F8C8D;
            --text-error: #C0392B;
            --text-sidebar-placeholder: #95A5A6;
            --text-file-loader-label: #BDC3C7;
            --text-file-picker: #34495E;

            --border-brick: #BDC3C7; /* Gray */
            --border-brick-title: #DDE4E6;
            --border-content-header: #2ECC71;
            --border-sidebar-divider: #2980B9;
            --border-settings-dropdown: #2980B9;
            --border-settings-group: #2980B9;
            --border-link-dotted: #E74C3C;
            --border-popover-card: #ABB2B9;
            --border-popover-card-header: #BDC3C7;
        }

        /* --- 48. Eye-Catching and Sleek (Visme) --- */
        body.theme-eye-catching-sleek {
            --font-primary: 'Electrolize', sans-serif; /* Sleek, modern */
            --font-secondary: 'Orbitron', sans-serif;
            --bg-page: #1A1A1A; /* Dark Background */
            --bg-header: #242424;
            --bg-sidebar: #1F1F1F;
            --bg-settings-dropdown: #1F1F1F;
            --bg-brick: #2C2C2C;
            --bg-button-nav: #009473; /* Viridian Green */
            --bg-button-nav-hover: #00A887;
            --bg-button-nav-active: #CF1259; /* Telemagenta */
            --bg-button-control: #009473;
            --bg-button-control-hover: #00A887;
            --bg-button-control-active: #CF1259;
            --bg-popup-hover: #383838;
            --bg-popover-card: #282828;
            
            --text-body: #D5D5D5;
            --text-header: #FFFFFF;
            --text-sidebar: #E5E5E5;
            --text-settings-dropdown: #E5E5E5;
            --text-settings-group-title: #B5B5B5;
            --text-brick: #D5D5D5;
            --text-brick-title: #CF1259; /* Telemagenta */
            --text-content-header: #009473; /* Viridian Green */
            --text-button-nav: #FFFFFF;
            --text-button-control: #FFFFFF;
            --text-link: #009473; /* Viridian Green */
            --text-link-hover: #30D8B7;
            --text-link-active: #CF1259; /* Telemagenta */
            --text-popup-hover: #FFFFFF;
            --text-popup-hover-strong: #CF1259;
            --text-popup-hover-em: #009473;
            --text-popover-card-header: #CF1259;
            --text-popover-card-body: #D5D5D5;
            --text-popover-card-strong: #CF1259;
            --text-popover-card-em: #009473;
            --text-loading: #C5C5C5;
            --text-error: #FF5080;
            --text-sidebar-placeholder: #888888;
            --text-file-loader-label: #B5B5B5;
            --text-file-picker: #E5E5E5;

            --border-brick: #404040;
            --border-brick-title: #505050;
            --border-content-header: #009473;
            --border-sidebar-divider: #3A3A3A;
            --border-settings-dropdown: #3A3A3A;
            --border-settings-group: #3A3A3A;
            --border-link-dotted: #009473;
            --border-popover-card: #505050;
            --border-popover-card-header: #454545;
        }


        /* --- Base Styles (using CSS variables) --- */
        body { 
            font-family: var(--font-primary); 
            margin: 0; 
            background-color: var(--bg-page); 
            color: var(--text-body); 
            line-height: var(--line-height-base); 
            font-size: var(--font-size-base); 
            min-height: 101vh; 
        }
        .site-header { 
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); 
            background-color: var(--bg-header); color: var(--text-header); 
            display: flex; align-items: center; padding: 0 15px; 
            box-shadow: var(--shadow-header); 
            z-index: 1001; transition: top var(--transition-duration) ease-in-out; 
        }
        .site-header.header-hidden { top: calc(-1 * var(--header-height)); }
        .hamburger-btn { 
            background: none; border: none; color: var(--hamburger-btn-color); 
            font-size: 24px; cursor: pointer; padding: 5px 10px; margin-right: 15px; 
            transition: background-color 0.2s; line-height: 1; 
            border-radius: var(--border-radius-small);
        }
        .hamburger-btn:hover { background-color: var(--hamburger-btn-hover-bg); }
        .header-title { font-size: 1.2em; font-weight: bold; }
        .settings-control-area { margin-left: auto; position: relative; }
        .settings-btn { 
            background: none; border: none; color: var(--settings-btn-color); 
            font-size: 22px; cursor: pointer; padding: 8px 12px; 
            border-radius: var(--border-radius-small); 
        }
        .settings-btn:hover { background-color: var(--settings-btn-hover-bg); }
        .settings-dropdown { 
            display: none; position: absolute; top: calc(100% + 5px); right: 0; 
            background-color: var(--bg-settings-dropdown); 
            border: 1px solid var(--border-settings-dropdown); 
            border-radius: var(--border-radius-base); 
            box-shadow: var(--shadow-settings-dropdown); 
            padding: 15px; z-index: 1002; min-width: 200px; /* Increased min-width for theme selector */
        }
        .settings-dropdown.visible { display: block; }
        .settings-dropdown h5 { 
            font-size: 0.9em; color: var(--text-settings-group-title); 
            margin-top: 0; margin-bottom: 8px; padding-bottom: 5px; 
            border-bottom: 1px solid var(--border-settings-group); 
        }
        .settings-group { margin-bottom: 15px; } .settings-group:last-child { margin-bottom: 0; }
        .column-control-btn, .align-control-btn { 
            display: block; width: 100%; text-align: left; 
            background-color: var(--bg-button-control); color: var(--text-button-control); 
            border: none; padding: 8px 12px; border-radius: var(--border-radius-small); 
            font-size: 0.85em; cursor: pointer; transition: background-color 0.2s; margin-bottom: 5px; 
        }
        .column-control-btn:hover, .align-control-btn:hover { background-color: var(--bg-button-control-hover); }
        .column-control-btn.active, .align-control-btn.active { background-color: var(--bg-button-control-active); font-weight: bold; }
        
        .theme-control-select { /* Style for the new theme select */
            width: 100%; 
            padding: 8px; 
            border-radius: var(--border-radius-small); 
            background-color: var(--bg-button-control); 
            color: var(--text-button-control); 
            border: 1px solid var(--border-sidebar-divider); /* Use a suitable border color */
            font-size: 0.85em;
            box-sizing: border-box;
        }

        .page-container { display: flex; padding-top: var(--header-height); min-height: 100vh; box-sizing: border-box; }
        .sidebar { 
            width: var(--sidebar-width); background-color: var(--bg-sidebar); 
            padding: var(--header-height) 0 15px 0; color: var(--text-sidebar); 
            box-shadow: var(--shadow-sidebar); 
            flex-shrink: 0; position: fixed; top: 0; left: 0; height: 100vh; overflow-y: auto; 
            transform: translateX(0); transition: transform var(--transition-duration) ease-in-out; 
            z-index: 1000; box-sizing: border-box; display: flex; flex-direction: column; 
        }
        body.sidebar-collapsed .sidebar { transform: translateX(-100%); }
        .sidebar h2 { 
            font-size: 1.2em; margin-top: 0; 
            border-bottom: 1px solid var(--border-sidebar-divider); 
            padding:0 15px 8px 15px; 
        }
        .sidebar-nav-container { flex-grow: 1; overflow-y: auto; padding: 0 15px; }
        .nav-button { 
            display: block; background-color: var(--bg-button-nav); color: var(--text-button-nav); 
            padding: 8px 10px; text-decoration: none; border-radius: var(--border-radius-small); 
            margin-bottom: 8px; transition: background-color 0.3s ease, box-shadow 0.3s ease; 
            font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .nav-button:hover { background-color: var(--bg-button-nav-hover); }
        .nav-button.active { 
            background-color: var(--bg-button-nav-active); font-weight: bold; 
            box-shadow: var(--shadow-nav-button-active); 
        }
        .file-loader-area { padding: 10px 15px; border-top: 1px solid var(--border-sidebar-divider); margin-top: auto; flex-shrink: 0; }
        .file-loader-area h4 { margin-top:0; margin-bottom:5px; font-size:0.9em; color: var(--text-file-loader-label);}
        #jsonFilePicker { color: var(--text-file-picker); font-size: 0.8em; width: 100%; } /* Color might need theme adjustment if sidebar bg changes drastically */
        
        .main-content { padding: 20px; margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width) - (20px * 2)); box-sizing: border-box; transition: margin-left var(--transition-duration) ease-in-out, width var(--transition-duration) ease-in-out; }
        body.sidebar-collapsed .main-content { margin-left: 0; width: calc(100% - (20px * 2)); }
        .content-header { 
            font-size: 1.5em; color: var(--text-content-header); 
            margin-bottom: 15px; padding-bottom: 8px; 
            border-bottom: 2px solid var(--border-content-header); 
        }
        .masonry-grid { display: grid; gap: 8px; }
        .masonry-grid.layout-auto { grid-template-columns: repeat(auto-fill, minmax(var(--brick-min-width-auto), 1fr)); }
        .masonry-grid.layout-auto.align-left { justify-content: flex-start; } .masonry-grid.layout-auto.align-center { justify-content: center; } .masonry-grid.layout-auto.align-right { justify-content: flex-end; }
        .masonry-grid.force-cols {}
        .masonry-grid.force-3-cols { grid-template-columns: repeat(3, minmax(0, var(--brick-max-width))); } .masonry-grid.force-4-cols { grid-template-columns: repeat(4, minmax(0, var(--brick-max-width))); } .masonry-grid.force-5-cols { grid-template-columns: repeat(5, minmax(0, var(--brick-max-width))); }
        .masonry-grid.force-cols.align-left { justify-content: flex-start; } .masonry-grid.force-cols.align-center { justify-content: center; } .masonry-grid.force-cols.align-right { justify-content: flex-end; }
        @media (max-width: 1640px) { body:not(.layout-auto) .masonry-grid.force-5-cols { grid-template-columns: repeat(4, minmax(0, var(--brick-max-width)));} }
        @media (max-width: 1310px) { body:not(.layout-auto) .masonry-grid.force-4-cols, body:not(.layout-auto) .masonry-grid.force-5-cols { grid-template-columns: repeat(3, minmax(0, var(--brick-max-width)));} }
        @media (max-width: 980px) { body:not(.layout-auto) .masonry-grid.force-3-cols, body:not(.layout-auto) .masonry-grid.force-4-cols, body:not(.layout-auto) .masonry-grid.force-5-cols { grid-template-columns: repeat(2, minmax(0, var(--brick-max-width)));} }
        @media (max-width: 650px) { .masonry-grid { grid-template-columns: minmax(0, 1fr); } .masonry-grid.align-center { justify-content: center; } .masonry-grid.align-right { justify-content: flex-end; } .masonry-grid.align-left { justify-content: flex-start; } }
        
        .brick { 
            background-color: var(--bg-brick); color: var(--text-brick);
            border: 1px solid var(--border-brick); 
            border-radius: var(--border-radius-base); 
            padding: 15px; box-shadow: var(--shadow-brick); 
            box-sizing: border-box; position: relative; 
            transition: box-shadow 0.2s ease-in-out; 
            width: 100%; max-width: var(--brick-max-width); 
        }
        .brick:hover { box-shadow: var(--shadow-brick-hover); }
        .brick-title { 
            font-size: 1.0em; font-weight: 600; color: var(--text-brick-title); 
            margin-top: 0; margin-bottom: 10px; padding-bottom: 6px; 
            border-bottom: 1px solid var(--border-brick-title); 
        }
        .sub-point-list { list-style: none; padding: 0; margin: 0; } .sub-point-list li { margin-bottom: 6px; font-size: 0.82em; position: relative; }
        .popup-trigger { 
            cursor: pointer; border-bottom: 1px dotted var(--border-link-dotted); 
            color: var(--text-link); 
            transition: color 0.2s ease, border-bottom-color 0.2s ease, border-bottom-style 0.2s ease; 
            display: inline; position: relative; padding-bottom: 1px; 
        }
        .popup-trigger:hover { color: var(--text-link-hover); border-bottom-color: var(--text-link-hover); }
        .popup-trigger.active-click { font-weight: bold; color: var(--text-link-active); border-bottom-style: solid; border-bottom-color: var(--text-link-active); }
        
        .hover-preview-popup { 
            visibility: hidden; opacity: 0; position: absolute; 
            background-color: var(--bg-popup-hover); color: var(--text-popup-hover); 
            padding: 5px 8px; border-radius: var(--border-radius-small); 
            font-size: 0.78em; line-height: 1.3; width: auto; min-width: 130px; max-width: 190px; 
            z-index: 1100; box-shadow: var(--shadow-popup-hover); 
            transition: opacity 0.1s ease-out; pointer-events: none; 
        }
        .hover-preview-popup strong { color: var(--text-popup-hover-strong); } 
        .hover-preview-popup em { color: var(--text-popup-hover-em); font-style: normal; }
        
        .popover-card { 
            visibility: hidden; opacity: 0; position: absolute; z-index: 1050; 
            background-color: var(--bg-popover-card); color: var(--text-popover-card-body);
            border: 1px solid var(--border-popover-card); 
            border-radius: var(--border-radius-base); 
            box-shadow: var(--shadow-popover-card); 
            padding: 12px 18px; width: 270px; max-width: 85vw; max-height: 65vh; 
            overflow-y: auto; transition: opacity 0.25s ease-in-out, visibility 0s linear 0.25s; 
            text-align: left; 
        }
        .popover-card.visible { visibility: visible; opacity: 1; transition-delay: 0s; }
        .popover-card-close-btn { 
            position: absolute; top: 6px; right: 8px; font-size: 20px; font-weight: bold; 
            color: var(--popover-close-btn-color); 
            cursor: pointer; border: none; background: none; padding: 0; line-height: 1; 
        }
        .popover-card-close-btn:hover { color: var(--popover-close-btn-hover-color); }
        .popover-card h4 { 
            margin-top: 0; color: var(--text-popover-card-header); 
            font-size: 0.9em; border-bottom: 1px solid var(--border-popover-card-header); 
            padding-bottom: 7px; margin-bottom: 8px; 
        }
        .popover-card strong { color: var(--text-popover-card-strong); } 
        .popover-card em { color: var(--text-popover-card-em); font-style: normal; font-weight: bold;}
        .popover-card ul { list-style: disc; padding-left: 16px; margin-top: 5px; margin-bottom: 3px; } 
        .popover-card ul li { margin-bottom: 3px; font-size: 0.78em; }
        
        .loading-message { text-align: center; padding: 20px; font-size: 1.1em; color: var(--text-loading); }
        .error-message { text-align: center; padding: 20px; font-size: 1.1em; color: var(--text-error); }
        #sidebarNavContainer > p { padding: 0 15px; font-size:0.85em; color: var(--text-sidebar-placeholder); }
    </style>
</head>
<body>
    <header class="site-header" id="siteHeader">
        <button class="hamburger-btn" id="hamburgerBtn" aria-label="Toggle navigation">&#9776;</button>
        <div class="header-title" id="headerTitle">Interactive Study Cards</div>
        <div class="settings-control-area">
            <button class="settings-btn" id="settingsBtn" aria-label="Layout Settings">&#9881;</button>
            <div class="settings-dropdown" id="settingsDropdown">
                <div class="settings-group">
                    <h5>Columns</h5>
                    <button class="column-control-btn" data-cols="auto">Auto</button>
                    <button class="column-control-btn active" data-cols="3">3 Columns</button>
                    <button class="column-control-btn" data-cols="4">4 Columns</button>
                    <button class="column-control-btn" data-cols="5">5 Columns</button>
                </div>
                <div class="settings-group">
                    <h5>Alignment</h5>
                    <button class="align-control-btn active" data-align="left">Left</button>
                    <button class="align-control-btn" data-align="center">Center</button>
                    <button class="align-control-btn" data-align="right">Right</button>
                </div>
                <div class="settings-group">
                    <h5>Theme</h5>
                    <select id="themeSelector" class="theme-control-select">
                        <option value="daylight">Daylight</option>
                        <option value="night-time">Night Time</option>
                        <option value="monochromatic">Monochromatic</option>
                        <option value="monochromatic-night">Monochromatic Night</option>
                        <option value="futuristic">Futuristic</option>
                        <option value="funky">Funky</option>
                        <option value="vintage">Vintage</option>
                        <option value="classic">Classic</option>
                        <option value="innovative-audacious">Innovative & Audacious (Visme)</option>
                        <option value="minimal-warm">Minimal & Warm (Visme)</option>
                        <option value="vivid-sharp">Vivid & Sharp (Visme)</option>
                        <option value="clean-modern">Clean & Modern (Visme)</option>
                        <option value="modern-minimalist">Modern & Minimalist (Visme)</option>
                        <option value="flat-design">Flat Design (Visme)</option>
                        <option value="eye-catching-sleek">Eye-Catching & Sleek (Visme)</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <div class="page-container">
        <aside class="sidebar" id="sidebar">
            <h2>SUBJECTS</h2>
            <div class="sidebar-nav-container" id="sidebarNavContainer">
                <p>Load JSON subject file(s) using the option below.</p>
            </div>
            <div class="file-loader-area">
                <h4 style="margin-top:0; margin-bottom:5px; font-size:0.9em;">Load Subject File(s):</h4>
                <input type="file" id="jsonFilePicker" accept=".json" multiple style="font-size: 0.8em;">
            </div>
        </aside>

        <main class="main-content" id="mainContent">
            <h1 class="content-header" id="contentHeader">Select or Load a Subject</h1>
            <div class="masonry-grid force-cols force-3-cols align-left" id="masonryGrid">
                <p class="loading-message">Please load JSON subject file(s) using the sidebar to view content.</p>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const { computePosition, offset, flip, shift, autoUpdate } = FloatingUIDOM;

    const bodyEl = document.body;
    const siteHeader = document.getElementById('siteHeader');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsDropdown = document.getElementById('settingsDropdown');
    const masonryGrid = document.getElementById('masonryGrid');
    const headerTitleEl = document.getElementById('headerTitle');
    const contentHeaderEl = document.getElementById('contentHeader');
    const sidebarNavContainer = document.getElementById('sidebarNavContainer');
    const jsonFilePicker = document.getElementById('jsonFilePicker');
    const themeSelector = document.getElementById('themeSelector'); 

    let currentlyOpenClickPopover = null;
    let currentlyActiveClickTrigger = null;
    let currentClickPopoverCleanup = null;
    let lastScrollTop = 0;
    let headerHeight, scrollThreshold;
    let loadedSubjects = []; 

    const THEME_STORAGE_KEY = 'studyCardsTheme';
    const themes = [
        "daylight", "night-time", "monochromatic", "monochromatic-night", 
        "futuristic", "funky", "vintage", "classic",
        "innovative-audacious", "minimal-warm", "vivid-sharp",
        "clean-modern", "modern-minimalist", "flat-design", "eye-catching-sleek"
    ];

    function applyTheme(themeName) {
        themes.forEach(t => bodyEl.classList.remove(`theme-${t}`));
        
        if (themes.includes(themeName)) {
            bodyEl.classList.add(`theme-${themeName}`);
            localStorage.setItem(THEME_STORAGE_KEY, themeName);
            if (themeSelector.value !== themeName) {
                themeSelector.value = themeName;
            }
        } else { 
            bodyEl.classList.add('theme-daylight');
            localStorage.setItem(THEME_STORAGE_KEY, 'daylight');
             if (themeSelector.value !== 'daylight') {
                themeSelector.value = 'daylight';
            }
        }
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
        if (savedTheme && themes.includes(savedTheme)) {
            applyTheme(savedTheme);
        } else {
            applyTheme('daylight'); 
        }
    }

    function initializeApp() {
        loadTheme(); 
        setupHeaderScroll();
        setupControls(); 
    }
    
    themeSelector.addEventListener('change', (event) => {
        applyTheme(event.target.value);
    });

    function populateSidebarNavFromLoadedSubjects() {
        sidebarNavContainer.innerHTML = '';
        if (loadedSubjects.length === 0) {
            sidebarNavContainer.innerHTML = `<p>Load JSON subject file(s) using the option below.</p>`;
            return;
        }
        loadedSubjects.sort((a, b) => a.displayName.localeCompare(b.displayName));

        loadedSubjects.forEach((subject, index) => {
            const navButton = document.createElement('a');
            navButton.href = '#';
            navButton.className = 'nav-button';
            navButton.textContent = subject.displayName;
            navButton.dataset.subjectIndex = index;
            navButton.addEventListener('click', handleNavClick);
            sidebarNavContainer.appendChild(navButton);
        });
    }

    function handleNavClick(event) {
        event.preventDefault();
        const clickedButton = event.currentTarget;
        document.querySelectorAll('#sidebarNavContainer .nav-button').forEach(btn => btn.classList.remove('active'));
        clickedButton.classList.add('active');

        const subjectIndex = parseInt(clickedButton.dataset.subjectIndex, 10);
        const selectedSubject = loadedSubjects[subjectIndex];

        if (selectedSubject) {
            renderSubjectContent(selectedSubject.data.sections, selectedSubject.displayName);
        } else {
            console.error("Selected subject data not found for index:", subjectIndex);
            masonryGrid.innerHTML = `<p class="error-message">Error: Could not find data for selected subject.</p>`;
        }
    }

    function renderSubjectContent(sectionsData, overallSubjectTitle) {
        masonryGrid.innerHTML = `<p class="loading-message">Loading ${overallSubjectTitle}...</p>`;
        if (headerTitleEl) headerTitleEl.textContent = `${overallSubjectTitle} Revision`;
        if (contentHeaderEl) contentHeaderEl.textContent = `${overallSubjectTitle} - Interactive Cards`;
        try {
            if (!Array.isArray(sectionsData)) {
                throw new Error(`Invalid data structure: "sections" array not found or not an array for ${overallSubjectTitle}`);
            }
            renderSectionsAsBricks(sectionsData);
            initializePopups();
        } catch (error) {
            console.error("Could not render content:", error);
            masonryGrid.innerHTML = `<p class="error-message">Error rendering ${overallSubjectTitle}. Details: ${error.message}. Check console.</p>`;
        }
    }

    jsonFilePicker.addEventListener('change', (event) => {
        const files = event.target.files;
        if (!files || files.length === 0) return;

        loadedSubjects = [];
        sidebarNavContainer.innerHTML = '<p class="loading-message">Processing files...</p>';
        masonryGrid.innerHTML = '<p class="loading-message">Select a subject from the sidebar after files are processed.</p>';
        contentHeaderEl.textContent = "Processing Files";
        headerTitleEl.textContent = "Processing Files";

        let filesToProcess = files.length;
        let processedCount = 0;
        let firstValidSubjectData = null; 
        let firstValidSubjectDisplayName = "";

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const subjectData = JSON.parse(e.target.result);
                    if (!subjectData.subjectTitle || !subjectData.sections || !Array.isArray(subjectData.sections)) {
                        console.warn(`Skipping file ${file.name}: Invalid structure. Missing "subjectTitle" or "sections" array.`);
                        alert(`File "${file.name}" has an invalid structure and will be skipped.`);
                    } else {
                        loadedSubjects.push({
                            displayName: subjectData.subjectTitle,
                            data: subjectData, 
                            fileName: file.name
                        });
                        if (!firstValidSubjectData) {
                            firstValidSubjectData = subjectData; 
                            firstValidSubjectDisplayName = subjectData.subjectTitle;
                        }
                    }
                } catch (parseError) {
                    console.error(`Error parsing ${file.name}:`, parseError);
                    alert(`Error parsing "${file.name}". It will be skipped.\n${parseError.message}`);
                } finally {
                    processedCount++;
                    if (processedCount === filesToProcess) {
                        populateSidebarNavFromLoadedSubjects();
                        if (firstValidSubjectData) {
                            const firstNavButton = sidebarNavContainer.querySelector('.nav-button');
                            if(firstNavButton) {
                                firstNavButton.classList.add('active');
                                renderSubjectContent(firstValidSubjectData.sections, firstValidSubjectDisplayName);
                            }
                        } else if (loadedSubjects.length === 0) {
                             sidebarNavContainer.innerHTML = '<p>No valid subject files loaded. Try again.</p>';
                             masonryGrid.innerHTML = '<p class="loading-message">Please load valid JSON subject file(s).</p>';
                             contentHeaderEl.textContent = "Load a Subject";
                             headerTitleEl.textContent = "Interactive Study Cards";
                        }
                        jsonFilePicker.value = '';
                    }
                }
            };
            reader.onerror = (e) => { 
                console.error(`Error reading ${file.name}:`, e); alert(`Error reading "${file.name}". It will be skipped.`);
                processedCount++; if (processedCount === filesToProcess) { populateSidebarNavFromLoadedSubjects(); if (loadedSubjects.length === 0 && !firstValidSubjectData) { sidebarNavContainer.innerHTML = '<p>No valid subject files loaded. Try again.</p>'; contentHeaderEl.textContent = "Load a Subject"; headerTitleEl.textContent = "Interactive Study Cards"; } jsonFilePicker.value = ''; }
            };
            reader.readAsText(file);
        });
    });

    function renderSectionsAsBricks(sectionsData) {
        masonryGrid.innerHTML = '';
        sectionsData.forEach(section => { 
            const brickDiv = document.createElement('div');
            brickDiv.className = 'brick'; 

            const titleH3 = document.createElement('h3');
            titleH3.className = 'brick-title'; 
            titleH3.textContent = section.sectionTitle; 
            brickDiv.appendChild(titleH3);

            const ul = document.createElement('ul');
            ul.className = 'sub-point-list';

            (section.topics || []).forEach(topic => { 
                const li = document.createElement('li');
                const triggerSpan = document.createElement('span');
                triggerSpan.className = 'popup-trigger';
                triggerSpan.textContent = topic.topicDisplayTitle; 

                const hoverPopupDiv = document.createElement('div');
                hoverPopupDiv.className = 'hover-preview-popup';
                hoverPopupDiv.innerHTML = topic.topicHoverSummary || 'No hover info'; 

                const clickPopoverDiv = document.createElement('div');
                clickPopoverDiv.className = 'popover-card';
                const closeBtn = document.createElement('button');
                closeBtn.className = 'popover-card-close-btn';
                closeBtn.innerHTML = '&times;';
                clickPopoverDiv.appendChild(closeBtn);

                const detailContentWrapper = document.createElement('div');
                detailContentWrapper.innerHTML = topic.topicDetailHtml || '<p>No detail content.</p>'; 
                clickPopoverDiv.appendChild(detailContentWrapper);

                triggerSpan.appendChild(hoverPopupDiv);
                li.appendChild(triggerSpan);
                li.appendChild(clickPopoverDiv);
                ul.appendChild(li);
            });
            brickDiv.appendChild(ul);
            masonryGrid.appendChild(brickDiv);
        });
        if (sectionsData.length === 0) {
            masonryGrid.innerHTML = '<p class="loading-message">No sections found for this subject.</p>';
        }
    }

    function initializePopups() {
        const triggers = document.querySelectorAll('.popup-trigger');
        if (currentClickPopoverCleanup) { currentClickPopoverCleanup(); currentClickPopoverCleanup = null; }
        closeCurrentClickPopover();
        triggers.forEach(trigger => {
            const hoverPreview = trigger.querySelector('.hover-preview-popup'); const clickPopover = trigger.nextElementSibling;
            if (!clickPopover || !clickPopover.classList.contains('popover-card')) { console.warn("Popover card structure issue for trigger:", trigger.textContent); return; }
            const closeBtn = clickPopover.querySelector('.popover-card-close-btn'); let hoverCleanupFunc = null;
            if (hoverPreview) {
                trigger.addEventListener('mouseenter', async () => { if (trigger !== currentlyActiveClickTrigger) { applyStyles(hoverPreview, { visibility: 'visible', opacity: '1' }); if (hoverCleanupFunc) hoverCleanupFunc(); hoverCleanupFunc = FloatingUIDOM.autoUpdate(trigger, hoverPreview, async () => { await positionPopup(trigger, hoverPreview, 'top', true); }, { animationFrame: true }); } });
                trigger.addEventListener('mouseleave', () => { applyStyles(hoverPreview, { visibility: 'hidden', opacity: '0' }); if (hoverCleanupFunc) { hoverCleanupFunc(); hoverCleanupFunc = null; } });
            }
            trigger.addEventListener('click', (event) => { event.stopPropagation(); if (hoverPreview) { applyStyles(hoverPreview, { visibility: 'hidden', opacity: '0' }); if (hoverCleanupFunc) { hoverCleanupFunc(); hoverCleanupFunc = null; } } if (clickPopover === currentlyOpenClickPopover) closeCurrentClickPopover(); else openClickPopover(trigger, clickPopover); });
            if (closeBtn) { closeBtn.addEventListener('click', (event) => { event.stopPropagation(); closeCurrentClickPopover(); }); }
            clickPopover.addEventListener('click', (event) => event.stopPropagation());
        });
    }
    function applyStyles(element, styles) { Object.assign(element.style, styles); }
    async function positionPopup(referenceEl, floatingEl, placement = 'top', isHover = false) { const middleware = [FloatingUIDOM.offset(isHover ? 6 : 12), FloatingUIDOM.flip({ padding: 15 }), FloatingUIDOM.shift({ padding: 15, crossAxis: true })]; try { const { x, y } = await FloatingUIDOM.computePosition(referenceEl, floatingEl, { placement, middleware }); applyStyles(floatingEl, { left: `${x}px`, top: `${y}px` }); } catch (e) { console.error("Positioning error:", e); applyStyles(floatingEl, { left: '10px', top: (referenceEl.getBoundingClientRect().bottom + 10) + 'px' }); } }
    function closeCurrentClickPopover() { if (currentClickPopoverCleanup) { currentClickPopoverCleanup(); currentClickPopoverCleanup = null; } if (currentlyOpenClickPopover) { applyStyles(currentlyOpenClickPopover, { visibility: 'hidden', opacity: '0' }); currentlyOpenClickPopover.classList.remove('visible'); currentlyOpenClickPopover = null; } if (currentlyActiveClickTrigger) { currentlyActiveClickTrigger.classList.remove('active-click'); currentlyActiveClickTrigger = null; } }
    async function openClickPopover(trigger, clickPopover) { closeCurrentClickPopover(); const hoverPreview = trigger.querySelector('.hover-preview-popup'); if (hoverPreview) applyStyles(hoverPreview, { visibility: 'hidden', opacity: '0' }); applyStyles(clickPopover, { visibility: 'visible', opacity: '1' }); clickPopover.classList.add('visible'); if (currentClickPopoverCleanup) currentClickPopoverCleanup(); currentClickPopoverCleanup = FloatingUIDOM.autoUpdate(trigger, clickPopover, async () => { await positionPopup(trigger, clickPopover, 'bottom'); }, { animationFrame: true }); trigger.classList.add('active-click'); currentlyOpenClickPopover = clickPopover; currentlyActiveClickTrigger = trigger; }
    hamburgerBtn.addEventListener('click', () => { bodyEl.classList.toggle('sidebar-collapsed'); hamburgerBtn.innerHTML = bodyEl.classList.contains('sidebar-collapsed') ? '&#9776;' : '&#10005;'; hamburgerBtn.setAttribute('aria-label', bodyEl.classList.contains('sidebar-collapsed') ? 'Open navigation' : 'Close navigation'); closeCurrentClickPopover(); if (settingsDropdown.classList.contains('visible')) settingsDropdown.classList.remove('visible'); });
    if (!bodyEl.classList.contains('sidebar-collapsed')) { hamburgerBtn.innerHTML = '&#10005;'; hamburgerBtn.setAttribute('aria-label', 'Close navigation'); }
    function setupHeaderScroll() { if (!siteHeader) return; headerHeight = siteHeader.offsetHeight; scrollThreshold = headerHeight * 0.8; }
    window.addEventListener('scroll', () => { if (!siteHeader) return; if (headerHeight === undefined) setupHeaderScroll(); let st = window.pageYOffset || document.documentElement.scrollTop; if (st > lastScrollTop && st > scrollThreshold) siteHeader.classList.add('header-hidden'); else if (st < lastScrollTop || st <= 5) siteHeader.classList.remove('header-hidden'); lastScrollTop = st <= 0 ? 0 : st; }, false);
    
    function setupControls() {
        const columnControlBtns = document.querySelectorAll('.column-control-btn'); const alignControlBtns = document.querySelectorAll('.align-control-btn');
        columnControlBtns.forEach(btn => { btn.addEventListener('click', () => { const cols = btn.dataset.cols; masonryGrid.className = 'masonry-grid'; bodyEl.classList.remove('layout-auto'); if (cols === 'auto') { masonryGrid.classList.add('layout-auto'); bodyEl.classList.add('layout-auto'); } else { masonryGrid.classList.add('force-cols'); masonryGrid.classList.add(`force-${cols}-cols`); } const currentAlignment = document.querySelector('.align-control-btn.active')?.dataset.align || 'left'; masonryGrid.classList.add(`align-${currentAlignment}`); columnControlBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); }); });
        alignControlBtns.forEach(btn => { btn.addEventListener('click', () => { const alignValue = btn.dataset.align; masonryGrid.classList.remove('align-left', 'align-center', 'align-right'); if (alignValue) masonryGrid.classList.add(`align-${alignValue}`); alignControlBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); }); });
        
        const defaultColBtn = document.querySelector('.column-control-btn[data-cols="3"]'); if(defaultColBtn) defaultColBtn.classList.add('active'); else if(columnControlBtns.length > 0) columnControlBtns[0].classList.add('active');
        const defaultAlignBtn = document.querySelector('.align-control-btn[data-align="left"]'); if(defaultAlignBtn) defaultAlignBtn.classList.add('active'); else if(alignControlBtns.length > 0) alignControlBtns[0].classList.add('active');

        settingsBtn.addEventListener('click', (event) => { event.stopPropagation(); settingsDropdown.classList.toggle('visible'); });
        document.addEventListener('click', (event) => { if (settingsDropdown.classList.contains('visible') && !settingsDropdown.contains(event.target) && event.target !== settingsBtn) settingsDropdown.classList.remove('visible'); if (currentlyOpenClickPopover && !currentlyOpenClickPopover.contains(event.target) && event.target !== currentlyActiveClickTrigger && !event.target.closest('.popup-trigger')) closeCurrentClickPopover(); });
        settingsDropdown.addEventListener('click', (event) => event.stopPropagation()); 
    }
    window.addEventListener('keydown', (event) => { if (event.key === 'Escape') { if (currentlyOpenClickPopover) closeCurrentClickPopover(); if (settingsDropdown.classList.contains('visible')) settingsDropdown.classList.remove('visible'); } });

    initializeApp();
});
</script>
</body>
</html>