<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Study Cards - No Collapse Icon</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@400;700&family=Electrolize&family=Fredoka+One&family=Bangers&family=Lobster&family=Playfair+Display:wght@400;700&family=Lato:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@floating-ui/core@1.6.0/dist/floating-ui.core.umd.js"></script>
    <script src="https://unpkg.com/@floating-ui/dom@1.6.3/dist/floating-ui.dom.umd.js"></script>
    <style>
        :root {
            /* Layout Variables */
            --sidebar-width: 220px;
            --header-height: 50px;
            --brick-max-width: 320px;
            --brick-min-width-auto: 240px;
            --transition-duration: 0.3s;
            --border-radius-base: 6px;
            --border-radius-small: 4px;

            /* Default Theme (Daylight) Variables */
            --font-primary: 'Roboto', Arial, sans-serif;
            --font-secondary: 'Roboto', Arial, sans-serif; 
            --font-size-base: 13.5px;
            --line-height-base: 1.45;

            --bg-page: #eef1f5;
            --bg-header: #002244;
            --bg-sidebar: #003366;
            --bg-settings-dropdown: #003366;
            --bg-brick: #ffffff;
            --bg-button-nav: #004080;
            --bg-button-nav-hover: #0059b3;
            --bg-button-nav-active: #007bff;
            --bg-button-control: #004080;
            --bg-button-control-hover: #0059b3;
            --bg-button-control-active: #007bff;
            --bg-popup-hover: #4A5568;
            --bg-popover-card: #fff;
            
            --text-body: #444;
            --text-header: white;
            --text-sidebar: #fff;
            --text-settings-dropdown: #fff;
            --text-settings-group-title: #a8c0d8;
            --text-brick: #444;
            --text-brick-title: #0059b3;
            --text-content-header: #003366;
            --text-button-nav: #fff;
            --text-button-control: white;
            --text-link: #004880;
            --text-link-hover: #0059b3;
            --text-link-active: #c9302c;
            --text-popup-hover: #E2E8F0;
            --text-popup-hover-strong: #F6E05E;
            --text-popup-hover-em: #63B3ED;
            --text-popover-card-header: #0059b3;
            --text-popover-card-body: #444;
            --text-popover-card-strong: #d95f53;
            --text-popover-card-em: #31708f;
            --text-loading: #555;
            --text-error: red;
            --text-sidebar-placeholder: #ccc;
            --text-file-loader-label: #a8c0d8;
            --text-file-picker: white;

            --border-brick: #d8dde3;
            --border-brick-title: #e0e0e0;
            --border-content-header: #0059b3;
            --border-sidebar-divider: #004080;
            --border-settings-dropdown: #004080;
            --border-settings-group: #004080;
            --border-link-dotted: #007bff;
            --border-popover-card: #c5cdd7;
            --border-popover-card-header: #e8edf1;

            --shadow-header: 0 2px 5px rgba(0,0,0,0.2);
            --shadow-sidebar: 2px 0 5px rgba(0,0,0,0.1);
            --shadow-brick: 0 1px 2px rgba(0,0,0,0.06);
            --shadow-brick-hover: 0 3px 8px rgba(0,0,0,0.12);
            --shadow-nav-button-active: inset 2px 2px 4px rgba(0,0,0,0.2);
            --shadow-settings-dropdown: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-popup-hover: 0 2px 8px rgba(0,0,0,0.2);
            --shadow-popover-card: 0 5px 15px rgba(0,0,0,0.2);

            --hamburger-btn-color: white;
            --hamburger-btn-hover-bg: rgba(255,255,255,0.1);
            --settings-btn-color: white;
            --settings-btn-hover-bg: rgba(255,255,255,0.1);
            --popover-close-btn-color: #aaa;
            --popover-close-btn-hover-color: #333;

            /* Checkbox Variables */
            --checkbox-border-color: #b0bec5;
            --checkbox-tick-color: #4caf50;
            --checkbox-cross-color: #f44336;
            --checkbox-background: #ffffff;
            --checkbox-background-hover: #e8edf1;
        }

        /* --- Night Time Theme (Embedded) --- */
        body.theme-night-time {
            --font-primary: 'Open Sans', sans-serif;
            --bg-page: #1a1f2c;
            --bg-header: #1f2536;
            --bg-sidebar: #2c3346;
            --bg-settings-dropdown: #2c3346;
            --bg-brick: #252b3b;
            --bg-button-nav: #3a4258;
            --bg-button-nav-hover: #4a526b;
            --bg-button-nav-active: #5c6784;
            --bg-button-control: #3a4258;
            --bg-button-control-hover: #4a526b;
            --bg-button-control-active: #5c6784;
            --bg-popup-hover: #3a4258;
            --bg-popover-card: #2c3346;
            
            --text-body: #d8dee9;
            --text-header: #e5e9f0;
            --text-sidebar: #e5e9f0;
            --text-settings-dropdown: #e5e9f0;
            --text-settings-group-title: #a3b8cc;
            --text-brick: #d8dee9;
            --text-brick-title: #88c0d0;
            --text-content-header: #88c0d0;
            --text-button-nav: #e5e9f0;
            --text-button-control: #e5e9f0;
            --text-link: #81a1c1;
            --text-link-hover: #88c0d0;
            --text-link-active: #bf616a;
            --text-popup-hover: #d8dee9;
            --text-popup-hover-strong: #ebcb8b;
            --text-popup-hover-em: #a3be8c;
            --text-popover-card-header: #88c0d0;
            --text-popover-card-body: #d8dee9;
            --text-popover-card-strong: #bf616a;
            --text-popover-card-em: #b48ead;
            --text-loading: #b0b8c9;
            --text-error: #e06c75;
            --text-sidebar-placeholder: #788297;
            --text-file-loader-label: #a3b8cc;
            --text-file-picker: #d8dee9;

            --border-brick: #3b4252;
            --border-brick-title: #434c5e;
            --border-content-header: #5e81ac;
            --border-sidebar-divider: #3b4252;
            --border-settings-dropdown: #3b4252;
            --border-settings-group: #3b4252;
            --border-link-dotted: #81a1c1;
            --border-popover-card: #434c5e;
            --border-popover-card-header: #434c5e;

            --shadow-header: 0 2px 5px rgba(0,0,0,0.3);
            --shadow-sidebar: 2px 0 5px rgba(0,0,0,0.25);
            --shadow-brick: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-brick-hover: 0 3px 8px rgba(0,0,0,0.3);
            --shadow-nav-button-active: inset 2px 2px 4px rgba(0,0,0,0.3);
            --shadow-settings-dropdown: 0 4px 12px rgba(0,0,0,0.25);
            --shadow-popup-hover: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-popover-card: 0 5px 15px rgba(0,0,0,0.3);

            --hamburger-btn-color: var(--text-header);
            --hamburger-btn-hover-bg: rgba(229,233,240,0.1);
            --settings-btn-color: var(--text-header);
            --settings-btn-hover-bg: rgba(229,233,240,0.1);
            --popover-close-btn-color: #9090a0;
            --popover-close-btn-hover-color: #d8dee9;

            /* Checkbox Variables - Night Theme */
            --checkbox-border-color: #546e7a;
            --checkbox-tick-color: #81c784;
            --checkbox-cross-color: #e57373;
            --checkbox-background: #37474f;
            --checkbox-background-hover: #455a64;
        }

        /* --- Base Styles (using CSS variables) --- */
        body { 
            font-family: var(--font-primary); 
            margin: 0; 
            background-color: var(--bg-page); 
            color: var(--text-body); 
            line-height: var(--line-height-base); 
            font-size: var(--font-size-base); 
            min-height: 101vh; 
        }
        .site-header { 
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); 
            background-color: var(--bg-header); color: var(--text-header); 
            display: flex; align-items: center; padding: 0 15px; 
            box-shadow: var(--shadow-header); 
            z-index: 1001; transition: top var(--transition-duration) ease-in-out; 
        }
        .site-header.header-hidden { top: calc(-1 * var(--header-height)); }
        .hamburger-btn { 
            background: none; border: none; color: var(--hamburger-btn-color); 
            font-size: 24px; cursor: pointer; padding: 5px 10px; margin-right: 15px; 
            transition: background-color 0.2s; line-height: 1; 
            border-radius: var(--border-radius-small);
        }
        .hamburger-btn:hover { background-color: var(--hamburger-btn-hover-bg); }
        .header-title { font-size: 1.2em; font-weight: bold; }
        .settings-control-area { margin-left: auto; position: relative; }
        .settings-btn { 
            background: none; border: none; color: var(--settings-btn-color); 
            font-size: 22px; cursor: pointer; padding: 8px 12px; 
            border-radius: var(--border-radius-small); 
        }
        .settings-btn:hover { background-color: var(--settings-btn-hover-bg); }
        .settings-dropdown { 
            display: none; position: absolute; top: calc(100% + 5px); right: 0; 
            background-color: var(--bg-settings-dropdown); 
            border: 1px solid var(--border-settings-dropdown); 
            border-radius: var(--border-radius-base); 
            box-shadow: var(--shadow-settings-dropdown); 
            padding: 15px; z-index: 1002; min-width: 220px;
        }
        .settings-dropdown.visible { display: block; }
        .settings-dropdown h5 { 
            font-size: 0.9em; color: var(--text-settings-group-title); 
            margin-top: 0; margin-bottom: 8px; padding-bottom: 5px; 
            border-bottom: 1px solid var(--border-settings-group); 
        }
        .settings-group { margin-bottom: 15px; } .settings-group:last-child { margin-bottom: 0; }
        .column-control-btn, .align-control-btn, .theme-file-load-btn { 
            display: block; width: 100%; text-align: left; 
            background-color: var(--bg-button-control); color: var(--text-button-control); 
            border: none; padding: 8px 12px; border-radius: var(--border-radius-small); 
            font-size: 0.85em; cursor: pointer; transition: background-color 0.2s; margin-bottom: 5px; 
            box-sizing: border-box;
        }
        .column-control-btn:hover, .align-control-btn:hover, .theme-file-load-btn:hover { background-color: var(--bg-button-control-hover); }
        .column-control-btn.active, .align-control-btn.active { background-color: var(--bg-button-control-active); font-weight: bold; }
        
        .theme-control-select {
            width: 100%; 
            padding: 8px; 
            border-radius: var(--border-radius-small); 
            background-color: var(--bg-button-control); 
            color: var(--text-button-control); 
            border: 1px solid var(--border-sidebar-divider);
            font-size: 0.85em;
            box-sizing: border-box;
            margin-bottom: 5px;
        }
        #themeJsonPicker {
            display: block;
            width: 100%;
            font-size: 0.8em;
            color: var(--text-file-picker);
            margin-bottom: 8px;
        }

        .page-container { display: flex; padding-top: var(--header-height); min-height: 100vh; box-sizing: border-box; }
        .sidebar { 
            width: var(--sidebar-width); background-color: var(--bg-sidebar); 
            padding: var(--header-height) 0 15px 0; color: var(--text-sidebar); 
            box-shadow: var(--shadow-sidebar); 
            flex-shrink: 0; position: fixed; top: 0; left: 0; height: 100vh; overflow-y: auto; 
            transform: translateX(0); transition: transform var(--transition-duration) ease-in-out; 
            z-index: 1000; box-sizing: border-box; display: flex; flex-direction: column; 
        }
        body.sidebar-collapsed .sidebar { transform: translateX(-100%); }
        .sidebar h2 { 
            font-size: 1.2em; margin-top: 0; 
            border-bottom: 1px solid var(--border-sidebar-divider); 
            padding:0 15px 8px 15px; 
        }
        .sidebar-nav-container { flex-grow: 1; overflow-y: auto; padding: 0 15px; }
        .nav-button { 
            display: block; background-color: var(--bg-button-nav); color: var(--text-button-nav); 
            padding: 8px 10px; text-decoration: none; border-radius: var(--border-radius-small); 
            margin-bottom: 8px; transition: background-color 0.3s ease, box-shadow 0.3s ease; 
            font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .nav-button:hover { background-color: var(--bg-button-nav-hover); }
        .nav-button.active { 
            background-color: var(--bg-button-nav-active); font-weight: bold; 
            box-shadow: var(--shadow-nav-button-active); 
        }
        .file-loader-area { padding: 10px 15px; border-top: 1px solid var(--border-sidebar-divider); margin-top: auto; flex-shrink: 0; }
        .file-loader-area h4 { margin-top:0; margin-bottom:5px; font-size:0.9em; color: var(--text-file-loader-label);}
        #jsonFilePicker { color: var(--text-file-picker); font-size: 0.8em; width: 100%; } 
        
        .main-content { padding: 20px; margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width) - (20px * 2)); box-sizing: border-box; transition: margin-left var(--transition-duration) ease-in-out, width var(--transition-duration) ease-in-out; }
        body.sidebar-collapsed .main-content { margin-left: 0; width: calc(100% - (20px * 2)); }
        .content-header { 
            font-size: 1.5em; color: var(--text-content-header); 
            margin-bottom: 15px; padding-bottom: 8px; 
            border-bottom: 2px solid var(--border-content-header); 
        }
        .masonry-grid { 
            display: grid; 
            gap: 8px; 
            align-items: start; 
        }
        .masonry-grid.layout-auto { grid-template-columns: repeat(auto-fill, minmax(var(--brick-min-width-auto), 1fr)); }
        .masonry-grid.layout-auto.align-left { justify-content: flex-start; } .masonry-grid.layout-auto.align-center { justify-content: center; } .masonry-grid.layout-auto.align-right { justify-content: flex-end; }
        .masonry-grid.force-cols {}
        .masonry-grid.force-3-cols { grid-template-columns: repeat(3, minmax(0, var(--brick-max-width))); } .masonry-grid.force-4-cols { grid-template-columns: repeat(4, minmax(0, var(--brick-max-width))); } .masonry-grid.force-5-cols { grid-template-columns: repeat(5, minmax(0, var(--brick-max-width))); }
        .masonry-grid.force-cols.align-left { justify-content: flex-start; } .masonry-grid.force-cols.align-center { justify-content: center; } .masonry-grid.force-cols.align-right { justify-content: flex-end; }
        @media (max-width: 1640px) { body:not(.layout-auto) .masonry-grid.force-5-cols { grid-template-columns: repeat(4, minmax(0, var(--brick-max-width)));} }
        @media (max-width: 1310px) { body:not(.layout-auto) .masonry-grid.force-4-cols, body:not(.layout-auto) .masonry-grid.force-5-cols { grid-template-columns: repeat(3, minmax(0, var(--brick-max-width)));} }
        @media (max-width: 980px) { body:not(.layout-auto) .masonry-grid.force-3-cols, body:not(.layout-auto) .masonry-grid.force-4-cols, body:not(.layout-auto) .masonry-grid.force-5-cols { grid-template-columns: repeat(2, minmax(0, var(--brick-max-width)));} }
        @media (max-width: 650px) { .masonry-grid { grid-template-columns: minmax(0, 1fr); } .masonry-grid.align-center { justify-content: center; } .masonry-grid.align-right { justify-content: flex-end; } .masonry-grid.align-left { justify-content: flex-start; } }
        
        .brick { 
            background-color: var(--bg-brick); color: var(--text-brick);
            border: 1px solid var(--border-brick); 
            border-radius: var(--border-radius-base); 
            padding: 15px; box-shadow: var(--shadow-brick); 
            box-sizing: border-box; position: relative; 
            transition: box-shadow 0.2s ease-in-out, padding-bottom 0.35s ease-in-out; 
            width: 100%; max-width: var(--brick-max-width); 
        }
        .brick:hover { box-shadow: var(--shadow-brick-hover); }
        
        .brick-title { 
            font-size: 1.0em; 
            font-weight: 600; 
            color: var(--text-brick-title); 
            margin-top: 0; 
            margin-bottom: 10px;
            padding-bottom: 6px; 
            border-bottom: 1px solid var(--border-brick-title); 
            cursor: pointer; 
            position: relative; 
            /* padding-right: 20px; */ /* Removed for more text space */
            user-select: none; 
        }
        /* Removed .brick-title::after and .brick.brick-collapsed .brick-title::after rules */

        .brick-content-wrapper {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.35s ease-in-out, 
                        opacity 0.3s ease-in-out,
                        margin-top 0.35s ease-in-out;
            opacity: 1;
            margin-top: 0; 
        }
        .brick.brick-collapsed .brick-content-wrapper {
            max-height: 0;
            opacity: 0;
            margin-top: -10px; 
        }
        .brick.brick-collapsed {
            padding-bottom: 10px; 
        }
        .brick.brick-collapsed .sub-point-list {
            margin-top: 0;
            margin-bottom: 0;
        }

        .sub-point-list { list-style: none; padding: 0; margin: 0; } 
        .sub-point-list li { 
            margin-bottom: 6px; 
            font-size: 0.82em; 
            position: relative; 
            display: flex; 
            align-items: center; 
        }

        .tri-state-checkbox {
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border: 1px solid var(--checkbox-border-color);
            border-radius: var(--border-radius-small);
            margin-right: 8px;
            cursor: pointer;
            background-color: var(--checkbox-background);
            transition: background-color var(--transition-duration), border-color var(--transition-duration);
            flex-shrink: 0; 
            position: relative; 
        }
        .tri-state-checkbox:hover {
            background-color: var(--checkbox-background-hover);
        }
        .tri-state-checkbox::before {
            font-family: Arial, sans-serif;
            font-weight: bold;
            line-height: 1;
        }
        .tri-state-checkbox[data-state="ticked"]::before {
            content: '✓';
            color: var(--checkbox-tick-color);
            font-size: 13px;
        }
        .tri-state-checkbox[data-state="crossed"]::before {
            content: '×';
            color: var(--checkbox-cross-color);
            font-size: 15px;
        }

        .popup-trigger { 
            cursor: pointer; border-bottom: 1px dotted var(--border-link-dotted); 
            color: var(--text-link); 
            transition: color 0.2s ease, border-bottom-color 0.2s ease, border-bottom-style 0.2s ease; 
            display: inline-block; position: relative; padding-bottom: 1px; 
        }
        .popup-trigger:hover { color: var(--text-link-hover); border-bottom-color: var(--text-link-hover); }
        .popup-trigger.active-click { font-weight: bold; color: var(--text-link-active); border-bottom-style: solid; border-bottom-color: var(--text-link-active); }
        
        .hover-preview-popup { 
            visibility: hidden; opacity: 0; position: absolute; 
            background-color: var(--bg-popup-hover); color: var(--text-popup-hover); 
            padding: 5px 8px; border-radius: var(--border-radius-small); 
            font-size: 0.78em; line-height: 1.3; width: auto; min-width: 130px; max-width: 190px; 
            z-index: 1100; box-shadow: var(--shadow-popup-hover); 
            transition: opacity 0.1s ease-out; pointer-events: none; 
        }
        .hover-preview-popup strong { color: var(--text-popup-hover-strong); } 
        .hover-preview-popup em { color: var(--text-popup-hover-em); font-style: normal; }
        
        .popover-card { 
            visibility: hidden; opacity: 0; position: absolute; z-index: 1050; 
            background-color: var(--bg-popover-card); color: var(--text-popover-card-body);
            border: 1px solid var(--border-popover-card); 
            border-radius: var(--border-radius-base); 
            box-shadow: var(--shadow-popover-card); 
            padding: 12px 18px; width: 270px; max-width: 85vw; max-height: 65vh; 
            overflow-y: auto; transition: opacity 0.25s ease-in-out, visibility 0s linear 0.25s; 
            text-align: left; 
        }
        .popover-card.visible { visibility: visible; opacity: 1; transition-delay: 0s; }
        .popover-card-close-btn { 
            position: absolute; top: 6px; right: 8px; font-size: 20px; font-weight: bold; 
            color: var(--popover-close-btn-color); 
            cursor: pointer; border: none; background: none; padding: 0; line-height: 1; 
        }
        .popover-card-close-btn:hover { color: var(--popover-close-btn-hover-color); }
        .popover-card h4 { 
            margin-top: 0; color: var(--text-popover-card-header); 
            font-size: 0.9em; border-bottom: 1px solid var(--border-popover-card-header); 
            padding-bottom: 7px; margin-bottom: 8px; 
        }
        .popover-card strong { color: var(--text-popover-card-strong); } 
        .popover-card em { color: var(--text-popover-card-em); font-style: normal; font-weight: bold;}
        .popover-card ul { list-style: disc; padding-left: 16px; margin-top: 5px; margin-bottom: 3px; } 
        .popover-card ul li { margin-bottom: 3px; font-size: 0.78em; }
        
        .loading-message { text-align: center; padding: 20px; font-size: 1.1em; color: var(--text-loading); }
        .error-message { text-align: center; padding: 20px; font-size: 1.1em; color: var(--text-error); }
        #sidebarNavContainer > p { padding: 0 15px; font-size:0.85em; color: var(--text-sidebar-placeholder); }
    </style>
    <style id="custom-themes-style"></style>
</head>
<body>
    <header class="site-header" id="siteHeader">
        <button class="hamburger-btn" id="hamburgerBtn" aria-label="Toggle navigation">☰</button>
        <div class="header-title" id="headerTitle">Interactive Study Cards</div>
        <div class="settings-control-area">
            <button class="settings-btn" id="settingsBtn" aria-label="Layout Settings">⚙</button>
            <div class="settings-dropdown" id="settingsDropdown">
                <div class="settings-group">
                    <h5>Columns</h5>
                    <button class="column-control-btn" data-cols="auto">Auto</button>
                    <button class="column-control-btn active" data-cols="3">3 Columns</button>
                    <button class="column-control-btn" data-cols="4">4 Columns</button>
                    <button class="column-control-btn" data-cols="5">5 Columns</button>
                </div>
                <div class="settings-group">
                    <h5>Alignment</h5>
                    <button class="align-control-btn active" data-align="left">Left</button>
                    <button class="align-control-btn" data-align="center">Center</button>
                    <button class="align-control-btn" data-align="right">Right</button>
                </div>
                <div class="settings-group">
                    <h5>Theme</h5>
                    <select id="themeSelector" class="theme-control-select">
                        <option value="daylight">Daylight</option>
                        <option value="night-time">Night Time</option>
                    </select>
                </div>
                <div class="settings-group">
                    <h5>Load Custom Themes</h5>
                    <input type="file" id="themeJsonPicker" accept=".json">
                    <button id="loadThemesBtn" class="theme-file-load-btn">Load from File</button>
                    <p id="themeLoadStatus" style="font-size: 0.75em; margin-top: 5px; color: var(--text-settings-group-title);"></p>
                </div>
            </div>
        </div>
    </header>

    <div class="page-container">
        <aside class="sidebar" id="sidebar">
            <h2>SUBJECTS</h2>
            <div class="sidebar-nav-container" id="sidebarNavContainer">
                <p>Load JSON subject file(s) using the option below.</p>
            </div>
            <div class="file-loader-area">
                <h4 style="margin-top:0; margin-bottom:5px; font-size:0.9em;">Load Subject File(s):</h4>
                <input type="file" id="jsonFilePicker" accept=".json" multiple style="font-size: 0.8em;">
            </div>
        </aside>

        <main class="main-content" id="mainContent">
            <h1 class="content-header" id="contentHeader">Select or Load a Subject</h1>
            <div class="masonry-grid force-cols force-3-cols align-left" id="masonryGrid">
                <p class="loading-message">Please load JSON subject file(s) using the sidebar to view content.</p>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const { computePosition, offset, flip, shift, autoUpdate } = FloatingUIDOM;

    const bodyEl = document.body;
    const siteHeader = document.getElementById('siteHeader');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsDropdown = document.getElementById('settingsDropdown');
    const masonryGrid = document.getElementById('masonryGrid');
    const headerTitleEl = document.getElementById('headerTitle');
    const contentHeaderEl = document.getElementById('contentHeader');
    const sidebarNavContainer = document.getElementById('sidebarNavContainer');
    const jsonFilePicker = document.getElementById('jsonFilePicker');
    
    const themeSelector = document.getElementById('themeSelector');
    const themeJsonPicker = document.getElementById('themeJsonPicker');
    const loadThemesBtn = document.getElementById('loadThemesBtn');
    const customThemesStyleTag = document.getElementById('custom-themes-style');
    const themeLoadStatus = document.getElementById('themeLoadStatus');

    let currentlyOpenClickPopover = null;
    let currentlyActiveClickTrigger = null;
    let currentClickPopoverCleanup = null;
    let lastScrollTop = 0;
    let headerHeight, scrollThreshold;
    let loadedSubjects = []; 

    const THEME_STORAGE_KEY = 'studyCardsTheme';
    let availableThemes = [
        { id: "daylight", name: "Daylight" },
        { id: "night-time", name: "Night Time" }
    ];
    let loadedCustomThemeIds = [];

    function getTopicStorageKey(subjectTitle, sectionTitle, topicTitle) {
        const sanitize = (str) => String(str).trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
        const parts = [subjectTitle, sectionTitle, topicTitle].map(p => sanitize(p)).filter(p => p && p.length > 0);
        if (parts.length < 3) {
            // console.warn("Fallback topic key for:", subjectTitle, sectionTitle, topicTitle);
            return `topicState_fallback_${parts.join('_')}_${Math.random().toString(36).substring(2, 9)}`;
        }
        return `topicState_${parts.join('_')}`;
    }

    function getBrickStorageKey(subjectTitle, sectionTitle) {
        const sanitize = (str) => String(str).trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
        const parts = [subjectTitle, sectionTitle].map(p => sanitize(p)).filter(p => p && p.length > 0);
        if (parts.length < 2) {
            // console.warn("Fallback brick key for:", subjectTitle, sectionTitle);
            return `brickState_fallback_${parts.join('_')}_${Math.random().toString(36).substring(2, 9)}`;
        }
        return `brickState_${parts.join('_')}`;
    }

    function applyTheme(themeId) {
        availableThemes.forEach(t => bodyEl.classList.remove(`theme-${t.id}`));
        const themeExists = availableThemes.some(t => t.id === themeId);
        if (themeExists) {
            bodyEl.classList.add(`theme-${themeId}`);
            localStorage.setItem(THEME_STORAGE_KEY, themeId);
            if (themeSelector.value !== themeId) themeSelector.value = themeId;
        } else { 
            bodyEl.classList.add('theme-daylight');
            localStorage.setItem(THEME_STORAGE_KEY, 'daylight');
            if (themeSelector.value !== 'daylight') themeSelector.value = 'daylight';
        }
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
        applyTheme(savedTheme || 'daylight');
    }
    
    function rebuildThemeSelector() {
        const currentSelectedValue = themeSelector.value;
        themeSelector.innerHTML = ''; 
        availableThemes.forEach(theme => {
            const option = document.createElement('option');
            option.value = theme.id;
            option.textContent = theme.name;
            themeSelector.appendChild(option);
        });
        if (availableThemes.some(t => t.id === currentSelectedValue)) {
            themeSelector.value = currentSelectedValue;
        } else {
             const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
             if (savedTheme && availableThemes.some(t => t.id === savedTheme)) {
                themeSelector.value = savedTheme;
             } else {
                themeSelector.value = 'daylight';
             }
        }
    }

    loadThemesBtn.addEventListener('click', () => {
        if (themeJsonPicker.files.length > 0) {
            const file = themeJsonPicker.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const customThemesData = JSON.parse(e.target.result);
                    if (!Array.isArray(customThemesData)) throw new Error("Theme JSON must be an array.");
                    
                    customThemesStyleTag.innerHTML = '';
                    loadedCustomThemeIds.forEach(customId => {
                        const index = availableThemes.findIndex(t => t.id === customId);
                        if (index > -1) availableThemes.splice(index, 1);
                    });
                    loadedCustomThemeIds = [];
                    
                    let cssStringToInject = "";
                    let themesAddedCount = 0;
                    customThemesData.forEach(theme => {
                        if (theme && theme.id && theme.name && theme.cssVariables) {
                            if (availableThemes.some(t => t.id === theme.id)) {
                                console.warn(`Theme ID "${theme.id}" already exists. Skipping.`);
                                return;
                            }
                            cssStringToInject += `body.theme-${theme.id} {\n`;
                            for (const [variable, value] of Object.entries(theme.cssVariables)) {
                                cssStringToInject += `  ${variable}: ${value};\n`;
                            }
                            cssStringToInject += `}\n\n`;
                            availableThemes.push({ id: theme.id, name: theme.name });
                            loadedCustomThemeIds.push(theme.id);
                            themesAddedCount++;
                        } else {
                            console.warn("Skipping invalid theme object from JSON:", theme);
                        }
                    });
                    customThemesStyleTag.innerHTML = cssStringToInject;
                    rebuildThemeSelector(); 
                    themeLoadStatus.textContent = `${themesAddedCount} theme(s) loaded.`;
                    themeJsonPicker.value = ''; 
                    applyTheme(localStorage.getItem(THEME_STORAGE_KEY) || 'daylight');
                } catch (error) {
                    console.error("Error loading/parsing theme JSON:", error);
                    themeLoadStatus.textContent = `Error: ${error.message}`;
                    alert(`Error loading themes: ${error.message}`);
                }
            };
            reader.onerror = () => { themeLoadStatus.textContent = 'Error reading file.'; alert('Error reading theme file.'); };
            reader.readAsText(file);
        } else {
            themeLoadStatus.textContent = 'No file selected.';
        }
    });

    function initializeApp() {
        rebuildThemeSelector(); 
        loadTheme(); 
        setupHeaderScroll();
        setupControls(); 
        setupInteractions();
    }
    
    themeSelector.addEventListener('change', (event) => applyTheme(event.target.value));

    function populateSidebarNavFromLoadedSubjects() {
        sidebarNavContainer.innerHTML = '';
        if (loadedSubjects.length === 0) {
            sidebarNavContainer.innerHTML = `<p>Load JSON subject file(s) below.</p>`; return;
        }
        loadedSubjects.sort((a, b) => a.displayName.localeCompare(b.displayName));
        loadedSubjects.forEach((subject, index) => {
            const navButton = document.createElement('a');
            navButton.href = '#'; navButton.className = 'nav-button';
            navButton.textContent = subject.displayName; navButton.dataset.subjectIndex = index;
            navButton.addEventListener('click', handleNavClick);
            sidebarNavContainer.appendChild(navButton);
        });
    }

    function handleNavClick(event) {
        event.preventDefault();
        const clickedButton = event.currentTarget;
        document.querySelectorAll('#sidebarNavContainer .nav-button').forEach(btn => btn.classList.remove('active'));
        clickedButton.classList.add('active');
        const subjectIndex = parseInt(clickedButton.dataset.subjectIndex, 10);
        const selectedSubject = loadedSubjects[subjectIndex];
        if (selectedSubject) {
            renderSubjectContent(selectedSubject.data.sections, selectedSubject.displayName);
        } else {
            console.error("Selected subject data not found:", subjectIndex);
            masonryGrid.innerHTML = `<p class="error-message">Error: Subject data missing.</p>`;
        }
    }

    function renderSubjectContent(sectionsData, overallSubjectTitle) {
        masonryGrid.innerHTML = `<p class="loading-message">Loading ${overallSubjectTitle}...</p>`;
        if (headerTitleEl) headerTitleEl.textContent = `${overallSubjectTitle} Revision`;
        if (contentHeaderEl) contentHeaderEl.textContent = `${overallSubjectTitle} - Cards`;
        try {
            if (!Array.isArray(sectionsData)) throw new Error(`Invalid sections data for ${overallSubjectTitle}`);
            renderSectionsAsBricks(sectionsData, overallSubjectTitle);
            initializePopups(); 
        } catch (error) {
            console.error("Render error:", error);
            masonryGrid.innerHTML = `<p class="error-message">Error rendering ${overallSubjectTitle}: ${error.message}</p>`;
        }
    }

    jsonFilePicker.addEventListener('change', (event) => { 
        const files = event.target.files;
        if (!files || files.length === 0) return;
        loadedSubjects = [];
        sidebarNavContainer.innerHTML = '<p class="loading-message">Processing...</p>';
        masonryGrid.innerHTML = '<p class="loading-message">Select subject after processing.</p>';
        contentHeaderEl.textContent = "Processing"; headerTitleEl.textContent = "Processing";
        let filesToProcess = files.length, processedCount = 0;
        let firstValidSubjectData = null, firstValidSubjectDisplayName = "";
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const subjectData = JSON.parse(e.target.result);
                    if (!subjectData.subjectTitle || !subjectData.sections || !Array.isArray(subjectData.sections)) {
                        throw new Error(`Invalid structure in ${file.name}.`);
                    }
                    loadedSubjects.push({ displayName: subjectData.subjectTitle, data: subjectData, fileName: file.name });
                    if (!firstValidSubjectData) {
                        firstValidSubjectData = subjectData; firstValidSubjectDisplayName = subjectData.subjectTitle;
                    }
                } catch (err) {
                    console.error(`Error with ${file.name}:`, err); alert(`${err.message} It will be skipped.`);
                } finally {
                    processedCount++;
                    if (processedCount === filesToProcess) {
                        populateSidebarNavFromLoadedSubjects();
                        if (firstValidSubjectData) {
                            const firstNavButton = sidebarNavContainer.querySelector('.nav-button');
                            if(firstNavButton) {
                                firstNavButton.classList.add('active');
                                renderSubjectContent(firstValidSubjectData.sections, firstValidSubjectDisplayName);
                            }
                        } else if (loadedSubjects.length === 0) {
                             sidebarNavContainer.innerHTML = '<p>No valid files loaded.</p>';
                             masonryGrid.innerHTML = '<p class="loading-message">Please load valid JSON files.</p>';
                             contentHeaderEl.textContent = "Load Subject"; headerTitleEl.textContent = "Study Cards";
                        }
                        jsonFilePicker.value = ''; 
                    }
                }
            };
            reader.onerror = (errEvt) => { 
                console.error(`Error reading ${file.name}:`, errEvt); alert(`Error reading "${file.name}". Skipped.`);
                processedCount++; if (processedCount === filesToProcess) { populateSidebarNavFromLoadedSubjects(); if (loadedSubjects.length === 0 && !firstValidSubjectData) { sidebarNavContainer.innerHTML = '<p>No valid files loaded.</p>'; contentHeaderEl.textContent = "Load Subject"; headerTitleEl.textContent = "Study Cards"; } jsonFilePicker.value = ''; }
            };
            reader.readAsText(file);
        });
    });

    function renderSectionsAsBricks(sectionsData, overallSubjectTitle) {
        masonryGrid.innerHTML = '';
        sectionsData.forEach(section => { 
            const brickDiv = document.createElement('div'); 
            brickDiv.className = 'brick collapsible-brick'; 
            
            const brickIdKey = getBrickStorageKey(overallSubjectTitle, section.sectionTitle);
            const isCollapsed = localStorage.getItem(brickIdKey) === 'true';
            if (isCollapsed) {
                brickDiv.classList.add('brick-collapsed');
            }

            const titleH3 = document.createElement('h3'); 
            titleH3.className = 'brick-title'; 
            titleH3.textContent = section.sectionTitle; 
            titleH3.setAttribute('tabindex', '0'); 
            titleH3.setAttribute('role', 'button');
            titleH3.setAttribute('aria-expanded', !isCollapsed);
            brickDiv.appendChild(titleH3);

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'brick-content-wrapper';

            const ul = document.createElement('ul'); 
            ul.className = 'sub-point-list';
            (section.topics || []).forEach(topic => { 
                const li = document.createElement('li');
                const topicIdKey = getTopicStorageKey(overallSubjectTitle, section.sectionTitle, topic.topicDisplayTitle);
                const savedState = localStorage.getItem(topicIdKey) || 'empty';
                const checkbox = document.createElement('span');
                checkbox.className = 'tri-state-checkbox';
                checkbox.setAttribute('data-state', savedState);
                checkbox.setAttribute('data-topic-key', topicIdKey);
                checkbox.setAttribute('role', 'checkbox');
                checkbox.setAttribute('aria-label', `Status for ${topic.topicDisplayTitle}`);
                checkbox.setAttribute('aria-checked', savedState === 'ticked' ? 'true' : (savedState === 'crossed' ? 'mixed' : 'false'));
                checkbox.setAttribute('tabindex', '0'); 
                li.appendChild(checkbox);

                const triggerSpan = document.createElement('span'); 
                triggerSpan.className = 'popup-trigger';
                triggerSpan.textContent = topic.topicDisplayTitle; 
                
                const hoverPopupDiv = document.createElement('div'); 
                hoverPopupDiv.className = 'hover-preview-popup';
                hoverPopupDiv.innerHTML = topic.topicHoverSummary || 'No hover info'; 
                
                const clickPopoverDiv = document.createElement('div'); 
                clickPopoverDiv.className = 'popover-card';
                const closeBtn = document.createElement('button'); 
                closeBtn.className = 'popover-card-close-btn';
                closeBtn.innerHTML = '×'; 
                clickPopoverDiv.appendChild(closeBtn);
                const detailContentWrapper = document.createElement('div');
                detailContentWrapper.innerHTML = topic.topicDetailHtml || '<p>No detail.</p>'; 
                clickPopoverDiv.appendChild(detailContentWrapper);

                triggerSpan.appendChild(hoverPopupDiv); 
                li.appendChild(triggerSpan); 
                li.appendChild(clickPopoverDiv); 
                ul.appendChild(li);
            });
            contentWrapper.appendChild(ul);
            brickDiv.appendChild(contentWrapper); 
            masonryGrid.appendChild(brickDiv);
        });
        if (sectionsData.length === 0) masonryGrid.innerHTML = '<p class="loading-message">No sections.</p>';
    }

    function initializePopups() {
        const triggers = document.querySelectorAll('.popup-trigger');
        if (currentClickPopoverCleanup) {
            currentClickPopoverCleanup();
            currentClickPopoverCleanup = null;
        }
        closeCurrentClickPopover(); 
        triggers.forEach(trigger => {
            const hoverPreview = trigger.querySelector('.hover-preview-popup');
            const clickPopover = trigger.parentElement.querySelector('.popover-card'); 
            if (!clickPopover) { 
                return;
            }
            const closeBtn = clickPopover.querySelector('.popover-card-close-btn');
            let hoverCleanupFunc = null;
            if (hoverPreview) {
                trigger.addEventListener('mouseenter', async () => {
                    if (trigger !== currentlyActiveClickTrigger) { 
                        if (hoverPreview.parentNode !== document.body) document.body.appendChild(hoverPreview);
                        applyStyles(hoverPreview, { visibility: 'visible', opacity: '1' });
                        if (hoverCleanupFunc) hoverCleanupFunc();
                        hoverCleanupFunc = FloatingUIDOM.autoUpdate(trigger, hoverPreview, 
                            async () => { await positionPopup(trigger, hoverPreview, 'top', true); },
                            { animationFrame: true }
                        );
                    }
                });
                trigger.addEventListener('mouseleave', () => {
                    applyStyles(hoverPreview, { visibility: 'hidden', opacity: '0' });
                    if (hoverPreview.parentNode === document.body) {
                        document.body.removeChild(hoverPreview); 
                    }
                    if (hoverCleanupFunc) {
                        hoverCleanupFunc(); hoverCleanupFunc = null;
                    }
                });
            }
            trigger.addEventListener('click', (event) => {
                event.stopPropagation();
                if (hoverPreview && hoverPreview.parentNode === document.body) {
                    applyStyles(hoverPreview, { visibility: 'hidden', opacity: '0' });
                    document.body.removeChild(hoverPreview);
                     if (hoverCleanupFunc) { hoverCleanupFunc(); hoverCleanupFunc = null; }
                }
                if (clickPopover === currentlyOpenClickPopover) {
                    closeCurrentClickPopover();
                } else {
                    openClickPopover(trigger, clickPopover);
                }
            });
            if (closeBtn) {
                closeBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    closeCurrentClickPopover();
                });
            }
            clickPopover.addEventListener('click', (event) => event.stopPropagation());
        });
    }

    function applyStyles(element, styles) { Object.assign(element.style, styles); }

    async function positionPopup(ref, flt, plc = 'top', isHov = false) { 
        const mid = [offset(isHov ? 6 : 12), flip({ padding: 15 }), shift({ padding: 15, crossAxis: true })]; 
        try { 
            const { x, y } = await computePosition(ref, flt, { placement: plc, middleware: mid }); 
            applyStyles(flt, { left: `${x}px`, top: `${y}px` }); 
        } catch (e) { 
            applyStyles(flt, { left: '10px', top: (ref.getBoundingClientRect().bottom + 10) + 'px' }); 
        } 
    }
    
    async function openClickPopover(trigger, clickPopover) {
        closeCurrentClickPopover(); 
        if (clickPopover.parentNode !== document.body) {
            document.body.appendChild(clickPopover);
        }
        applyStyles(clickPopover, { visibility: 'visible', opacity: '1' });
        clickPopover.classList.add('visible');
        if (currentClickPopoverCleanup) currentClickPopoverCleanup();
        currentClickPopoverCleanup = FloatingUIDOM.autoUpdate(trigger, clickPopover,
            async () => { await positionPopup(trigger, clickPopover, 'bottom'); },
            { animationFrame: true }
        );
        trigger.classList.add('active-click');
        currentlyOpenClickPopover = clickPopover;
        currentlyActiveClickTrigger = trigger;
    }

    function closeCurrentClickPopover() { 
        if (currentClickPopoverCleanup) { currentClickPopoverCleanup(); currentClickPopoverCleanup = null; } 
        if (currentlyOpenClickPopover) { 
            applyStyles(currentlyOpenClickPopover, { visibility: 'hidden', opacity: '0' }); 
            currentlyOpenClickPopover.classList.remove('visible');
            if (currentlyOpenClickPopover.parentNode === document.body) {
                document.body.removeChild(currentlyOpenClickPopover);
            }
            currentlyOpenClickPopover = null; 
        } 
        if (currentlyActiveClickTrigger) { 
            currentlyActiveClickTrigger.classList.remove('active-click'); 
            currentlyActiveClickTrigger = null; 
        } 
    }
    
    hamburgerBtn.addEventListener('click', () => { bodyEl.classList.toggle('sidebar-collapsed'); hamburgerBtn.innerHTML = bodyEl.classList.contains('sidebar-collapsed') ? '☰' : '✕'; hamburgerBtn.setAttribute('aria-label', bodyEl.classList.contains('sidebar-collapsed') ? 'Open nav' : 'Close nav'); closeCurrentClickPopover(); if (settingsDropdown.classList.contains('visible')) settingsDropdown.classList.remove('visible'); });
    if (!bodyEl.classList.contains('sidebar-collapsed')) { hamburgerBtn.innerHTML = '✕'; hamburgerBtn.setAttribute('aria-label', 'Close nav'); }
    
    function setupHeaderScroll() { if (!siteHeader) return; headerHeight = siteHeader.offsetHeight; scrollThreshold = headerHeight * 0.8; }
    window.addEventListener('scroll', () => { if (!siteHeader) return; if (headerHeight === undefined) setupHeaderScroll(); let st = window.pageYOffset || document.documentElement.scrollTop; if (st > lastScrollTop && st > scrollThreshold) siteHeader.classList.add('header-hidden'); else if (st < lastScrollTop || st <= 5) siteHeader.classList.remove('header-hidden'); lastScrollTop = st <= 0 ? 0 : st; }, false);
    
    function setupControls() {
        const colBtns = document.querySelectorAll('.column-control-btn'); const algnBtns = document.querySelectorAll('.align-control-btn');
        colBtns.forEach(btn => { btn.addEventListener('click', () => { const cols = btn.dataset.cols; masonryGrid.className = 'masonry-grid'; bodyEl.classList.remove('layout-auto'); if (cols === 'auto') { masonryGrid.classList.add('layout-auto'); bodyEl.classList.add('layout-auto'); } else { masonryGrid.classList.add('force-cols', `force-${cols}-cols`); } const curAlgn = document.querySelector('.align-control-btn.active')?.dataset.align || 'left'; masonryGrid.classList.add(`align-${curAlgn}`); colBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); }); });
        algnBtns.forEach(btn => { btn.addEventListener('click', () => { const algnVal = btn.dataset.align; masonryGrid.classList.remove('align-left', 'align-center', 'align-right'); if (algnVal) masonryGrid.classList.add(`align-${algnVal}`); algnBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); }); });
        const defColBtn = document.querySelector('.column-control-btn[data-cols="3"]'); if(defColBtn) defColBtn.classList.add('active'); else if(colBtns.length > 0) colBtns[0].classList.add('active');
        const defAlgnBtn = document.querySelector('.align-control-btn[data-align="left"]'); if(defAlgnBtn) defAlgnBtn.classList.add('active'); else if(algnBtns.length > 0) algnBtns[0].classList.add('active');
        settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsDropdown.classList.toggle('visible'); });
        document.addEventListener('click', (e) => { if (settingsDropdown.classList.contains('visible') && !settingsDropdown.contains(e.target) && e.target !== settingsBtn) settingsDropdown.classList.remove('visible'); if (currentlyOpenClickPopover && !currentlyOpenClickPopover.contains(e.target) && e.target !== currentlyActiveClickTrigger && !e.target.closest('.popup-trigger')) closeCurrentClickPopover(); });
        settingsDropdown.addEventListener('click', (e) => e.stopPropagation()); 
    }

    function setupInteractions() {
        masonryGrid.addEventListener('click', function(event) {
            const target = event.target;
            if (target.classList.contains('tri-state-checkbox')) {
                handleCheckboxClick(target);
            } else if (target.classList.contains('brick-title') && target.closest('.collapsible-brick')) {
                handleBrickCollapseToggle(target);
            }
        });
        masonryGrid.addEventListener('keydown', function(event) {
            const target = event.target;
            if (target.classList.contains('tri-state-checkbox') && (event.key === 'Enter' || event.key === ' ')) {
                event.preventDefault(); 
                handleCheckboxClick(target);
            } else if (target.classList.contains('brick-title') && target.closest('.collapsible-brick') && (event.key === 'Enter' || event.key === ' ')) {
                event.preventDefault();
                handleBrickCollapseToggle(target);
            }
        });
    }

    function handleCheckboxClick(cbEl) {
        let curSt = cbEl.getAttribute('data-state'); const topicKey = cbEl.getAttribute('data-topic-key');
        let nxtSt, nxtAria;
        if (curSt === 'empty') { nxtSt = 'ticked'; nxtAria = 'true'; }
        else if (curSt === 'ticked') { nxtSt = 'crossed'; nxtAria = 'mixed'; }
        else { nxtSt = 'empty'; nxtAria = 'false'; }
        cbEl.setAttribute('data-state', nxtSt); cbEl.setAttribute('aria-checked', nxtAria);
        if (topicKey) localStorage.setItem(topicKey, nxtSt);
        else console.warn("Checkbox missing key for saving state.");
    }

    function handleBrickCollapseToggle(titleElement) {
        const brick = titleElement.closest('.collapsible-brick');
        if (brick) {
            const isCurrentlyCollapsed = brick.classList.toggle('brick-collapsed');
            titleElement.setAttribute('aria-expanded', !isCurrentlyCollapsed);

            const activeNavButton = sidebarNavContainer.querySelector('.nav-button.active');
            if (activeNavButton) {
                const subjectIndex = parseInt(activeNavButton.dataset.subjectIndex, 10);
                const currentSubject = loadedSubjects[subjectIndex];
                if (currentSubject) {
                    const subjectTitle = currentSubject.displayName;
                    const sectionTitle = titleElement.textContent; 
                    const brickKey = getBrickStorageKey(subjectTitle, sectionTitle);
                    if (isCurrentlyCollapsed) {
                        localStorage.setItem(brickKey, 'true');
                    } else {
                        localStorage.removeItem(brickKey); 
                    }
                }
            }
        }
    }

    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (currentlyOpenClickPopover) closeCurrentClickPopover(); if (settingsDropdown.classList.contains('visible')) settingsDropdown.classList.remove('visible'); } });

    initializeApp();
});
</script>
</body>
</html>
